<!DOCTYPE html>
<html lang="fr">
<head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-F7J6VTB5BZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-F7J6VTB5BZ');
</script>
  <meta charset="UTF-8" />
  <title>Jeu à SafeMates</title>
  <meta name="description" content="Configurez votre profil de joueur, choisissez votre rang et trouvez des coéquipiéres pour vos parties sur SafeMates." />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#22c55e" />

  <!-- Preconnect pour optimiser le chargement -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" />

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" media="print" onload="this.media='all'" />
  <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" /></noscript>
  <link rel="stylesheet" href="/style.css?v=1768165762094" />
  <link rel="stylesheet" href="/ads.css?v=1768165762094" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
  <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" /></noscript>

  <!-- Google AdSense Script -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9926958602882647"
     crossorigin="anonymous"></script>

  <style>
    /* On réutilise les mémes variables et styles de base pour la cohérence */
    :root { 
        --primary-color: #22c55e; 
        --primary-hover: #16a34a;
        --primary-light: rgba(34, 197, 94, 0.1);
        --sidebar-width: 320px; 
        --side-nav-width: 230px;
        --game-info-width: 280px; 
        --bg-dark: #0a0f1e; 
        --bg-card: #1a2332; 
        --bg-card-hover: #242d3f;
        --text-main: #f8fafc; 
        --text-muted: #94a3b8; 
        --border-color: #334155;
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.2);
        --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.3);
        --shadow-glow: 0 0 20px rgba(34, 197, 94, 0.2);
    }
    body { 
        background: linear-gradient(135deg, #0a0f1e 0%, #0f172a 50%, #0a0f1e 100%);
        background-attachment: fixed;
        color: var(--text-main); 
        font-family: 'Inter', sans-serif; 
        margin: 0; 
        overflow-x: hidden; 
        padding-left: var(--side-nav-width); 
    }
    
    /* HEADER */
    header { display: none; }
    .logo { color: var(--primary-color); font-size: 1.5rem; font-weight: 800; text-decoration: none; }
    .nav-links a { color: var(--text-main); text-decoration: none; margin-left: 25px; transition: color 0.2s; }
    .nav-links a:hover { color: var(--primary-color); }
    .profile-section { display: flex; align-items: center; }
    .profile-avatar { width: 35px; height: 35px; border-radius: 50%; background: var(--primary-color); color: var(--bg-dark); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1rem; margin-right: 15px; cursor: pointer; }

    /* --- SIDE NAV --- */
    .side-nav {
        position: fixed;
        top: 0;
        left: 0;
        width: var(--side-nav-width);
        height: 100vh;
        background: linear-gradient(180deg, rgba(15,23,42,0.95) 0%, rgba(10,15,30,0.95) 100%);
        border-right: 1px solid rgba(255,255,255,0.05);
        box-shadow: 8px 0 30px rgba(0,0,0,0.35);
        padding: 20px 16px;
        box-sizing: border-box;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 14px;
    }

    .side-nav .nav-title {
        font-weight: 800;
        letter-spacing: -0.02em;
        font-size: 1.1rem;
        color: var(--primary-color);
        margin-bottom: 10px;
    }

    .side-nav a.nav-link {
        color: var(--text-main);
        text-decoration: none;
        padding: 10px 8px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        gap: 10px;
        background: transparent;
        border: none;
        transition: color 0.2s, transform 0.15s;
    }

    .side-nav a.nav-link:hover {
        color: var(--primary-color);
        transform: translateX(2px);
    }

    .side-nav .nav-toggle {
        background: transparent;
        color: var(--text-main);
        border: none;
        border-radius: 6px;
        padding: 10px 8px;
        width: 100%;
        text-align: left;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        font-weight: 600;
    }

    .side-nav .nav-toggle .chevron {
        transition: transform 0.2s ease;
    }

    .side-nav .nav-toggle.open .chevron {
        transform: rotate(90deg);
    }

    .side-nav .nav-sublist {
        display: none;
        flex-direction: column;
        gap: 6px;
        margin-left: 10px;
        padding-left: 6px;
        border-left: 1px solid rgba(255,255,255,0.08);
    }

    .side-nav .nav-sublist.open {
        display: flex;
    }

    .side-nav .nav-sublist a {
        color: var(--text-main);
        text-decoration: none;
        padding: 8px 6px;
        border-radius: 6px;
        background: transparent;
        border: none;
        transition: color 0.2s, transform 0.15s;
        font-size: 0.95rem;
    }

    .side-nav .nav-sublist a:hover {
        color: var(--primary-color);
        transform: translateX(2px);
    }

    /* LAYOUT PRINCIPAL */
    .game-layout {
        width: calc(100% - 24px);
        max-width: 1500px;
        margin: 30px 0 40px 0;
        padding: 0 8px;
        display: flex;
        gap: 24px;
        margin-left: 16px;
    }

    /* COLONNE GAUCHE (INFO JEU) */
    .game-info-column {
        flex: 0 0 var(--game-info-width);
        position: sticky;
        top: 95px; /* Décalage pour le header */
        height: fit-content;
        padding: 20px;
        background: var(--bg-card);
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    .game-title-info { font-size: 1.8rem; font-weight: 800; margin-bottom: 10px; color: var(--primary-color); }
    .game-stats p { font-size: 0.95rem; color: var(--text-muted); margin: 5px 0; }
    .info-line { display: flex; justify-content: space-between; margin-bottom: 5px; }
    .info-label { font-weight: 500; color: var(--text-main); }
    .info-value { color: var(--text-muted); }
    /* L'ancienne régle .update-btn est retirée/modifiée ici */
    .update-btn:hover { opacity: 0.9; }

    /* COLONNE CENTRALE (OPTIONS & MATCH) */
    .main-content-column {
        flex-grow: 1;
        min-width: 0;
    }
    h2 { color: var(--text-main); margin-bottom: 20px; border-bottom: 1px solid #334155; padding-bottom: 5px; font-size: 1.5rem; }
    
    /* PARTIE RANG / MODE */
    .settings-grid {
        display: grid;
        grid-template-columns: 1.35fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }
    .setting-box {
        background: var(--bg-card);
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    .style-toggle {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-top: 12px;
    }
    .style-toggle button {
        padding: 10px;
        border-radius: 8px;
        border: 2px solid #334155;
        background: var(--bg-dark);
        color: var(--text-muted);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }
    .style-toggle button.active {
        border-color: var(--primary-color);
        color: var(--text-main);
        background: rgba(34, 197, 94, 0.18);
    }
    .setting-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; color: var(--text-main); }
    .radio-group { display: flex; flex-direction: column; gap: 10px; }
    .radio-option { display: flex; align-items: center; gap: 10px; cursor: pointer; }
    .radio-option input[type="radio"], .radio-option input[type="checkbox"] { display: none; }
    .radio-option label {
        padding: 8px 12px; border-radius: 6px; border: 2px solid #334155;
        background: var(--bg-dark); color: var(--text-muted);
        transition: all 0.2s; cursor: pointer;
        flex-grow: 1; text-align: center;
        pointer-events: auto;
        position: relative;
        z-index: 1;
    }
    .radio-option label:hover {
        border-color: #4a5568;
        background: rgba(34, 197, 94, 0.1);
    }
    .radio-option input[type="radio"]:checked + label,
    .radio-option input[type="checkbox"]:checked + label {
        border-color: var(--primary-color);
        background: rgba(34, 197, 94, 0.2);
        color: var(--text-main);
    }
    .rank-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
    }

    @media (max-width: 1200px) {
        .settings-grid {
            grid-template-columns: repeat(2, minmax(260px, 1fr));
        }
    }

    @media (max-width: 900px) {
        .game-layout {
            flex-direction: column;
        }
        .settings-grid {
            grid-template-columns: 1fr;
        }
    }
    .rank-option {
        text-align: center;
        cursor: pointer;
        opacity: 0.6;
        transition: opacity 0.2s, transform 0.2s;
        border: 2px solid transparent;
        border-radius: 8px;
        padding: 5px;
        position: relative;
        z-index: 1;
        pointer-events: auto;
    }
    .rank-option:hover {
        opacity: 0.8;
        transform: scale(1.02);
    }
    .rank-option.active {
        opacity: 1;
        transform: scale(1.05);
        border-color: var(--primary-color);
    }
    .rank-option img {
        width: 100%;
        max-width: 60px;
        height: auto;
        border-radius: 4px;
        display: block;
        margin: 0 auto 5px;
        pointer-events: none;
    }
    .rank-option span {
        font-size: 0.8rem;
        color: var(--text-muted);
        pointer-events: none;
    }
    .rank-option.active span {
        color: var(--text-main);
        font-weight: 600;
    }
    .range-selector { margin-top: 15px; }
    .range-selector label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: var(--text-muted); }
    #rankRange { width: 100%; height: 8px; background: #334155; border-radius: 4px; appearance: none; cursor: pointer; }
    #rankRange::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: var(--primary-color);
        cursor: pointer;
    }
    #rankRange::-moz-range-thumb {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: var(--primary-color);
        cursor: pointer;
    }

    /* PARTIE RECHERCHE DE PARTENAIRE */
    #partnerSearchButton {
        width: 100%;
        padding: 15px;
        font-size: 1.1rem;
        font-weight: 700;
        background: #f97316; /* Orange pour l'action principale */
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
    }
    #partnerSearchButton:hover { background: #ea580c; }
    #partnerSearchButton.searching {
        background: #334155;
        cursor: default;
    }
    .match-results { margin-top: 30px; }
    .match-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 15px;
        background: var(--bg-card);
        border-radius: 10px;
        margin-bottom: 10px;
        border-left: 5px solid var(--primary-color);
    }
    .match-info { display: flex; align-items: center; gap: 15px; }
    .match-rank-img { width: 40px; height: 40px; border-radius: 4px; }
    .match-username { font-weight: 600; font-size: 1.1rem; }
    .match-details { font-size: 0.9rem; color: var(--text-muted); }
    .match-actions button { 
        padding: 8px 15px; border: none; border-radius: 6px; 
        font-weight: 600; cursor: pointer; margin-left: 10px;
    }
    .add-friend-match { background: var(--primary-color); color: var(--bg-dark); }
    .send-msg-match { background: #3b82f6; color: white; }

    /* SIDEBAR & CHAT STYLES (alignés sur le dashboard) */
    .toggle-friends-btn {
      position: fixed;
      top: 90px;
      right: 20px;
      z-index: 10000;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
      color: #fff;
      border: none;
      padding: 12px 20px;
      border-radius: 50px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 0.95rem;
      box-shadow: 0 8px 24px rgba(34, 197, 94, 0.4);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .toggle-friends-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(34, 197, 94, 0.5);
    }

    .toggle-friends-btn.active {
        right: calc(var(--sidebar-width) + 20px);
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
    }

    .toggle-friends-btn.active:hover {
        box-shadow: 0 12px 32px rgba(239, 68, 68, 0.5);
    }
    
    .toggle-friends-btn.active span {
        display: none;
    }

    .toggle-friends-btn.active::after {
        content: "✕";
        font-size: 1.2rem;
    }

    .social-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
    }

    .user-pill {
        padding: 8px 12px;
        border-radius: 8px;
        background: rgba(34, 197, 94, 0.1);
        color: var(--text-main);
        font-weight: 600;
        font-size: 0.9rem;
        border: 1px solid rgba(34, 197, 94, 0.3);
        white-space: nowrap;
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: right;
    }

    /* --- SIDEBAR SOCIALE (Amis) --- */
    .friends-sidebar {
      position: fixed;
      top: 0;
      right: calc(0px - var(--sidebar-width));
      width: var(--sidebar-width);
      height: 100vh;
      background: rgba(10, 15, 30, 0.98);
      border-left: 2px solid rgba(34, 197, 94, 0.1);
      box-shadow: -20px 0 60px rgba(0, 0, 0, 0.6);
      padding: 90px 20px 20px;
      z-index: 1000;
      transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      gap: 15px;
      backdrop-filter: blur(20px) saturate(180%);
      box-sizing: border-box;
      overflow-y: auto;
    }

    .friends-sidebar::-webkit-scrollbar {
      width: 6px;
    }

    .friends-sidebar::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }

    .friends-sidebar::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 10px;
    }

    .friends-sidebar::-webkit-scrollbar-thumb:hover {
      background: var(--primary-hover);
    }
    
    .friends-sidebar.active { 
        right: 0; 
    } 

    .sidebar-section-title { 
        font-size: 0.75rem; 
        text-transform: uppercase; 
        color: var(--text-muted); 
        margin-top: 15px; 
        font-weight: 700; 
    }
    
    .friend-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        border-radius: 12px;
        background: var(--bg-card);
        border: 1px solid rgba(255, 255, 255, 0.05);
        cursor: pointer;
        margin-bottom: 8px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .friend-card::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 3px;
        background: var(--primary-color);
        transform: scaleY(0);
        transition: transform 0.3s ease;
    }

    .friend-card:hover {
        background: var(--bg-card-hover);
        border-color: rgba(34, 197, 94, 0.3);
        transform: translateX(4px);
    }

    .friend-card:hover::before {
        transform: scaleY(1);
    }
    
    .friend-avatar { 
        width: 32px; 
        height: 32px; 
        border-radius: 50%; 
        background: #3b82f6; 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        font-weight: bold; 
        margin-right: 10px; 
        color: white;
    }
    
    .add-friend-box { 
        display: flex; 
        gap: 5px; 
    }
    
    .add-friend-box input { 
        flex: 1; 
        background: rgba(0,0,0,0.3); 
        border: 1px solid #334155; 
        border-radius: 20px; 
        padding: 6px 12px; 
        color: white; 
        outline: none; 
    }
    
    .add-friend-box button { 
        background: var(--primary-color); 
        border: none; 
        width: 32px; 
        height: 32px; 
        border-radius: 50%; 
        cursor: pointer; 
        font-weight: bold; 
        color: var(--bg-dark);
    }

    /* CHAT CONTAINER & WINDOW */
    .chat-container { 
        position: fixed; 
        bottom: 0; 
        right: calc(20px); 
        display: flex; 
        flex-direction: row-reverse; 
        gap: 15px; 
        z-index: 900; 
        transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        pointer-events: none; 
    }
    
    .friends-sidebar.active ~ .chat-container { 
        right: calc(var(--sidebar-width) + 20px); 
    }
    
    .chat-window {
        width: 300px; 
        height: 400px; 
        background: var(--bg-card); 
        border-radius: 12px 12px 0 0; 
        display: flex; 
        flex-direction: column;
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.4);
        pointer-events: auto; 
    }
    
    .chat-header {
        padding: 10px 15px; 
        background: var(--primary-color); 
        color: var(--bg-dark); 
        font-weight: 600; 
        cursor: pointer; 
        display: flex;
        justify-content: space-between; 
        align-items: center; 
        border-radius: 10px 10px 0 0;
    }
    
    .chat-body {
        flex-grow: 1; 
        overflow-y: auto; 
        padding: 15px; 
        display: flex; 
        flex-direction: column; 
        gap: 8px; 
        background: #141c2c;
    }
    
    .msg {
        max-width: 70%;
        padding: 10px 14px;
        border-radius: 18px;
        font-size: 0.9rem;
        word-wrap: break-word;
        margin: 4px 0;
        position: relative;
        animation: messageSlideIn 0.3s ease-out;
    }

    .msg.self {
        background: var(--primary-color);
        color: white;
        align-self: flex-end;
        margin-left: auto;
        margin-right: 8px;
        border-bottom-right-radius: 4px;
    }

    .msg.other {
        background: #9ca3af;
        color: #1f2937;
        align-self: flex-start;
        margin-right: auto;
        margin-left: 8px;
        border-bottom-left-radius: 4px;
    }

    /* Animation d'apparition des messages */
    @keyframes messageSlideIn {
        from {
            opacity: 0;
            transform: translateY(10px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    /* Queue de bulle pour les messages envoyés (vert) */
    .msg.self::before {
        content: '';
        position: absolute;
        bottom: 0;
        right: -8px;
        width: 0;
        height: 0;
        border-left: 8px solid var(--primary-color);
        border-top: 8px solid transparent;
        border-bottom: 8px solid transparent;
    }

    /* Queue de bulle pour les messages reéus (gris) */
    .msg.other::before {
        content: '';
        position: absolute;
        bottom: 0;
        left: -8px;
        width: 0;
        height: 0;
        border-right: 8px solid #9ca3af;
        border-top: 8px solid transparent;
        border-bottom: 8px solid transparent;
    }
    
    .chat-input-area { 
        display: flex; 
        padding: 10px; 
        border-top: 1px solid #334155; 
    }
    
    .chat-input-area input { 
        flex-grow: 1; 
        padding: 10px; 
        border: 1px solid #334155; 
        border-radius: 8px; 
        background: var(--bg-dark); 
        color: var(--text-main); 
        margin-right: 10px; 
        outline: none; 
    }
    
    .chat-input-area button {
        background: var(--primary-color);
        color: var(--bg-dark);
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1rem;
    }

    /* Style pour le bouton de suppression d'ami */
    .remove-friend-btn:hover {
        background: #ef4444 !important;
        color: white !important;
        transform: scale(1.1);
    }

    /* Badge de notification sur le bouton Amis */
    .friends-notification-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        background: #ef4444;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 0.7rem;
        display: none;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        border: 2px solid var(--bg-dark);
        animation: pulse 2s infinite;
    }

    .friends-notification-badge.active {
        display: flex;
    }

    /* Badge sur une carte d'ami avec message non lu */
    .friend-card-badge {
        background: var(--primary-color);
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 0.7rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-left: auto;
        margin-right: 8px;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% {
            transform: scale(1);
            opacity: 1;
        }
        50% {
            transform: scale(1.1);
            opacity: 0.8;
        }
    }

    /* --- BOUTON HAMBURGER MOBILE --- */
    .mobile-menu-toggle {
      display: none;
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1001;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 12px;
      color: var(--bg-dark);
      font-size: 1.3rem;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
      transition: all 0.3s ease;
    }

    .mobile-menu-toggle:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(34, 197, 94, 0.5);
    }

    .mobile-menu-toggle:active {
      transform: scale(0.95);
    }

    /* --- RESPONSIVE MOBILE --- */
    @media (max-width: 768px) {
      /* Afficher le bouton hamburger sur mobile */
      .mobile-menu-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* Navigation latérale rétractable sur mobile */
      .side-nav {
        left: calc(0px - var(--side-nav-width));
        transition: left 0.3s ease;
      }

      .side-nav.mobile-active {
        left: 0;
      }

      /* Overlay pour fermer le menu */
      .mobile-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }

      .mobile-overlay.active {
        display: block;
      }

      /* Supprimer le padding left du body */
      body {
        padding-left: 0;
      }

      /* Réajuster la mise en page du jeu */
      .game-layout {
        width: 100%;
        padding: 15px 10px;
        margin: 0;
      }

      /* Améliorer la grille de rangs sur mobile */
      .rank-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
      }

      /* Ajuster les options de paramètres */
      .settings-grid {
        gap: 15px;
      }

      .setting-box {
        padding: 15px;
      }

      /* Améliorer les boutons de style de jeu */
      .style-toggle {
        grid-template-columns: 1fr;
      }

      /* Ajuster les titres */
      h2 {
        font-size: 1.3rem;
        margin-bottom: 15px;
      }

      /* Améliorer la zone de matchmaking */
      .match-section {
        padding: 15px;
      }

      /* Ajuster les cartes de joueurs trouvés */
      .player-card {
        padding: 12px;
      }
    }

    @media (max-width: 480px) {
      /* Pour les très petits écrans */
      .game-layout {
        padding: 10px 5px;
      }

      .rank-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 6px;
      }

      .setting-box {
        padding: 12px;
      }

      h2 {
        font-size: 1.2rem;
      }

      /* Réduire l'espacement */
      .settings-grid {
        gap: 12px;
      }
    }

  </style>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-5W9WJ9ZKEK"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-5W9WJ9ZKEK');
  </script>
</head>
<body class="game-page">

    <!-- Bouton hamburger mobile -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Overlay mobile -->
    <div class="mobile-overlay" id="mobileOverlay"></div>

    <nav class="side-nav" id="sideNav">
        <div class="nav-title" style="display: flex; align-items: center; gap: 10px;">
            <img src="Image/Logo safe mate.png" alt="SafeMates Logo" style="width: 32px; height: 32px; border-radius: 50%;">
            <span>SafeMates</span>
        </div>
        <a class="nav-link" href="/dashboard"><i class="fas fa-home"></i><span>Accueil</span></a>
        <a class="nav-link" href="/contact.html"><i class="fas fa-envelope"></i><span>Contact</span></a>
        <a class="nav-link" id="moderationLink" href="/moderation" style="display: none;"><i class="fas fa-shield-alt"></i><span>Modération</span></a>
        <a class="nav-link logout-link" href="#"><i class="fas fa-sign-out-alt"></i><span>Déconnexion</span></a>

        <button class="nav-toggle" data-target="navLinks">
            <span><i class="fas fa-link"></i> Liens utiles</span>
            <i class="fas fa-chevron-right chevron"></i>
        </button>
        <div class="nav-sublist" id="navLinks">
            <a href="https://www.tiktok.com/@SafeMatesfeminin?_r=1&_t=ZN-91t95JhqJxH" target="_blank" rel="noopener"><i class="fab fa-tiktok"></i> TikTok</a>
            <a href="https://www.instagram.com/SafeMates_girl/" target="_blank" rel="noopener"><i class="fab fa-instagram"></i> Instagram</a>
            <a href="https://x.com/MatesMatch13487" target="_blank" rel="noopener"><i class="fab fa-twitter"></i> X (Twitter)</a>
        </div>
    </nav>

    <header>
        <div class="logo">
            <img src="Image/Logo safe mate.png" alt="SafeMates" class="logo-img" width="40" height="40">
            <div class="logo-text">SafeMates</div>
        </div>
        <div class="nav-links">
            <a href="/dashboard">Tableau de bord</a>
            <a href="#" class="logout-link-header">Déconnexion</a>
        </div>
        <div class="profile-section">
            <div class="profile-avatar">U</div> 
        </div>
    </header>

    <div class="game-layout">

        <div class="game-info-column">
            <div class="game-title-info" id="gameTitle">Jeu - SafeMates</div>
            <img id="gameImg" src="Image/Image_jeux/valorant.jpg" alt="Valorant" style="width: 100%; height: auto; border-radius: 8px; margin-bottom: 20px; object-fit: contain;" loading="lazy" width="280" height="373">

            <div class="game-stats">
                <div class="info-line"><span class="info-label">Profils enregistrés :</span><span id="playerCount" class="info-value">0</span></div>
                <div class="info-line"><span class="info-label">Mode de jeu :</span><span id="gameModeDisplay" class="info-value">Non défini</span></div>
                <div class="info-line"><span class="info-label">Votre Rang :</span><span id="userRankDisplay" class="info-value">Non défini</span></div>
                <div class="info-line"><span class="info-label">Tolérance :</span><span id="rankRangeDisplay" class="info-value">é1 Rang</span></div>
            </div>
            
            </div>

        <div class="main-content-column">
            
            <h2>Mon profil de joueur</h2>
            <div class="settings-grid">
                
                <div class="setting-box">
                    <div class="setting-title">Votre grade Actuel</div>
                    <div class="rank-grid" id="rankGrid">
                        </div>
                </div>

                <div class="setting-box">
                    <div class="setting-title">Mode de Jeu</div>
                    <div class="radio-group" id="modeGroup">
                        </div>
                    <div class="setting-title" style="margin-top: 18px;">Style de jeu</div>
                    <div class="style-toggle" id="styleToggle">
                        <button type="button" data-style="chill">Chill</button>
                        <button type="button" data-style="tryhard">Try hard</button>
                    </div>
                </div>

            </div>
            <button class="update-btn" id="saveSettingsBtn" style="margin-top: -10px; margin-bottom: 30px; width: 50%; padding: 10px; background: var(--primary-color); color: var(--bg-dark); border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: opacity 0.2s;">Mettre à jour mes infos</button>
            <h2>Recherche de partenaire</h2>
            
            <div class="setting-box">
                <div class="setting-title">Préférences du partenaire</div>

                <div class="rank-grid" id="prefRankGrid">
                    </div>
                
                <div class="range-selector">
                    <label for="rankRange">Tolérance de Rang : <span id="rangeValue">é1 Rang</span></label>
                    <input type="range" id="rankRange" min="0" max="3" step="1" value="1">
                </div>
            </div>

            <button id="partnerSearchButton">
                <i class="fas fa-search"></i> <span>Rechercher un partenaire</span>
            </button>
            
            <div class="match-results">
                <h2>Partenaires potentiels (<span id="matchCount">0</span>)</h2>
                <div id="matchList">
                    <p style="color:var(--text-muted); text-align:center; padding: 20px; background: var(--bg-card); border-radius: 8px;">Lancez une recherche pour trouver des joueurs !</p>
                </div>
            </div>

        </div>

    </div>

    <button class="toggle-friends-btn" id="toggleFriendsBtn">
        <i class="fas fa-users"></i> <span>Amis</span>
        <span class="friends-notification-badge" id="friendsNotificationBadge">0</span>
    </button>
    
    <aside class="friends-sidebar" id="friendsSidebar">
        <div class="social-header">
            <h2 style="margin: 0; font-size: 1.1rem; color: var(--primary-color);">Social</h2>
            <div class="user-pill" id="connectedUsername">Utilisateur</div>
        </div>
        
        <div class="sidebar-section-title">Ajouter</div>
        <form class="add-friend-box" id="add-friend-form">
            <input type="text" id="friend-input" placeholder="Pseudo..." autocomplete="off">
            <button type="submit"><i class="fas fa-user-plus"></i></button>
        </form>
        <div id="friend-notif" style="color:var(--primary-color); font-size: 0.8rem; margin-top: 5px;"></div>

        <div class="sidebar-section-title">Amis (<span id="friendsCount">0</span>)</div>
        <div id="friendsList">
            <p style="text-align:center; color:var(--text-muted); font-size:0.9rem;">Ajoutez des amis !</p>
        </div>

        <div class="sidebar-section-title" id="receivedRequestsTitle" style="display:none;">Demandes reéues (<span id="receivedCount">0</span>)</div>
        <div id="requestsList">
            </div>
        
        <div class="sidebar-section-title" id="sentRequestsTitle" style="display:none;">Demandes envoyées (<span id="sentCount">0</span>)</div>
        <div id="sentList">
            </div>

    </aside>
    
    <div id="chat-container" class="chat-container"></div>
<script src="/chatmanager.js?v=1768165762094"></script>
<script>
        // ====================================================
        // --- 0. DéCLARATION DES VARIABLES GLOBALES ---
        // ====================================================

        // Vérification immédiate du ChatManager
        console.log('Vérification du ChatManager au chargement du script');
        console.log('ChatManager disponible:', !!window.ChatManager);
        console.log('globalChatManager disponible:', !!window.globalChatManager);

       // Variables de jeu
        const urlParams = new URLSearchParams(window.location.search);
        const gameId = urlParams.get('game') || 'valorant';
       let profileCountInterval = null;
       const gameInfo = {
            valorant: {
                title: 'Valorant',
                img: '/Image/Image_jeux/valorant.jpg',
                mainModes: ['Classé', 'Non Classé'],
                options: ['Vocal Obligatoire'],
                players: 15000 
            },
            lol: {
                title: 'League of Legends',
                img: '/Image/Image_jeux/lol.jpg',
                mainModes: ['Classé', 'Non Classé'],
                options: ['Vocal Obligatoire'],
                players: 25000 
            },
            csgo: {
                title: 'CS:GO',
                img: '/Image/Image_jeux/csgo.jpg',
                mainModes: ['Compétitif', 'Casual'],
                options: ['Vocal Obligatoire'],
                players: 8000 
            },
            rocketleague: {
                title: 'Rocket League',
                img: '/Image/Image_jeux/rocketleague.jpg',
                mainModes: ['1v1', '2v2', '3v3', 'Tournoi', 'Extra Modes'],
                options: ['Vocal Obligatoire'],
                players: 7000 
            },
            fortnite: {
                title: 'Fortnite',
                img: '/Image/Image_jeux/fortnite.jpg',
                mainModes: ['Battle Royale', 'Créatif', 'Sauver le monde'],
                options: ['Vocal Obligatoire'],
                players: 12000 
            },
            warzone: {
                title: 'Call of Duty: Warzone',
                img: '/Image/Image_jeux/warzone.avif',
                mainModes: ['Battle Royale', 'Plunder', 'Resurgence'],
                options: ['Vocal Obligatoire'],
                players: 9000 
            }
        };

        // Rangs unifiés avec le serveur (IDs raccourcis pour Valorant)
        const RANKS = {
            lol: [
                { id: 'iron',    name: 'Iron',    img: '/lol_rank/Iron.webp' },
                { id: 'bronze',  name: 'Bronze',  img: '/lol_rank/Bronze.webp' },
                { id: 'silver',  name: 'Silver',  img: '/lol_rank/Silver.webp' },
                { id: 'gold',    name: 'Gold',    img: '/lol_rank/Gold.webp' },
                { id: 'platinum',name: 'Platinum',img: '/lol_rank/Platinum.webp' },
                { id: 'emerald', name: 'Emerald', img: '/lol_rank/Emerald.webp' },
                { id: 'diamond', name: 'Diamant', img: '/lol_rank/diamond.webp' },
                { id: 'master',  name: 'Master',  img: '/lol_rank/Master.webp' },
                { id: 'grandmaster',  name: 'Grand Master', img: '/lol_rank/Grandmaster.webp' },
                { id: 'challenger', name: 'Challenger', img: '/lol_rank/Challenger.webp' },
            ],
            valorant: [
                { id: 'fer1', name: 'Fer 1', img: '/Valorant_rank/Iron_1_Rank.webp' },
                { id: 'fer2', name: 'Fer 2', img: '/Valorant_rank/Iron_2_Rank.webp' },
                { id: 'fer3', name: 'Fer 3', img: '/Valorant_rank/Iron_3_Rank.webp' },
                { id: 'bronze1', name: 'Bronze 1', img: '/Valorant_rank/Bronze_1_Rank.webp' },
                { id: 'bronze2', name: 'Bronze 2', img: '/Valorant_rank/Bronze_2_Rank.webp' },
                { id: 'bronze3', name: 'Bronze 3', img: '/Valorant_rank/Bronze_3_Rank.webp' },
                { id: 'argent1', name: 'Argent 1', img: '/Valorant_rank/Silver_1_Rank.webp' },
                { id: 'argent2', name: 'Argent 2', img: '/Valorant_rank/Silver_2_Rank.webp' },
                { id: 'argent3', name: 'Argent 3', img: '/Valorant_rank/Silver_3_Rank.webp' },
                { id: 'or1', name: 'Or 1', img: '/Valorant_rank/Gold_1_Rank.webp' },
                { id: 'or2', name: 'Or 2', img: '/Valorant_rank/Gold_2_Rank.webp' },
                { id: 'or3', name: 'Or 3', img: '/Valorant_rank/Gold_3_Rank.webp' },
                { id: 'platine1', name: 'Platine 1', img: '/Valorant_rank/Platinum_1_Rank.webp' },
                { id: 'platine2', name: 'Platine 2', img: '/Valorant_rank/Platinum_2_Rank.webp' },
                { id: 'platine3', name: 'Platine 3', img: '/Valorant_rank/Platinum_3_Rank.webp' },
                { id: 'diamant1', name: 'Diamant 1', img: '/Valorant_rank/Diamond_1_Rank.webp' },
                { id: 'diamant2', name: 'Diamant 2', img: '/Valorant_rank/Diamond_2_Rank.webp' },
                { id: 'diamant3', name: 'Diamant 3', img: '/Valorant_rank/Diamond_3_Rank.webp' },
                { id: 'ascendant_1', name: 'Ascendant 1', img: '/Valorant_rank/Ascendant_1_Rank.webp' },
                { id: 'ascendant_2', name: 'Ascendant 2', img: '/Valorant_rank/Ascendant_2_Rank.webp' },
                { id: 'ascendant_3', name: 'Ascendant 3', img: '/Valorant_rank/Ascendant_3_Rank.webp' },
                { id: 'immortal_1', name: 'Immortal 1', img: '/Valorant_rank/Immortal_1_Rank.webp' },
                { id: 'immortal_2', name: 'Immortal 2', img: '/Valorant_rank/Immortal_2_Rank.webp' },
                { id: 'immortal_3', name: 'Immortal 3', img: '/Valorant_rank/Immortal_3_Rank.webp' },
                { id: 'radiant', name: 'Radiant', img: '/Valorant_rank/Radiant_Rank.webp' },
            ],
            csgo: [
                { id: 'silver', name: 'Silver I', img: '/csgo_rank/silver.png' },
                { id: 'silver2', name: 'Silver II', img: '/csgo_rank/silver 2.png' },
                { id: 'silver3', name: 'Silver III', img: '/csgo_rank/silver3.png' },
                { id: 'silver4', name: 'Silver IV', img: '/csgo_rank/silver4.jpg' },
                { id: 'silver5', name: 'Silver Elite', img: '/csgo_rank/silver5.png' },
                { id: 'silver6', name: 'Silver Elite Master', img: '/csgo_rank/silver6.png' },
                { id: 'gold1', name: 'Gold Nova I', img: '/csgo_rank/gold_nova_1_cec4b69c20.png' },
                { id: 'gold2', name: 'Gold Nova II', img: '/csgo_rank/gold2.png' },
                { id: 'gold3', name: 'Gold Nova III', img: '/csgo_rank/goldnova3.png' },
                { id: 'gold4', name: 'Gold Nova Master', img: '/csgo_rank/gold4.png' },
                { id: 'mg1', name: 'Master Guardian I', img: '/csgo_rank/mastyerguardian1.webp' },
                { id: 'mg2', name: 'Master Guardian II', img: '/csgo_rank/masterguardian2.png' },
                { id: 'mge', name: 'Master Guardian Elite', img: '/csgo_rank/masterguardianélite.png' },
                { id: 'dmg', name: 'Distinguished Master Guardian', img: '/csgo_rank/distinguishedmasterguardian.jpg' },
                { id: 'le', name: 'Legendary Eagle', img: '/csgo_rank/legendaryeagle.png' },
                { id: 'lem', name: 'Legendary Eagle Master', img: '/csgo_rank/legendaryeaglemaster.jpg' },
                { id: 'supreme', name: 'Supreme Master First Class', img: '/csgo_rank/supreme_master_first_class_d274bcdb5f.png' },
                { id: 'global', name: 'Global Elite', img: '/csgo_rank/globalelite.jpg' },
            ],
            rocketleague: [
                { id: 'bronze', name: 'Bronze', img: '/rocketleague_rank/bronze.webp' },
                { id: 'silver', name: 'Silver', img: '/rocketleague_rank/silver.png' },
                { id: 'gold', name: 'Gold', img: '/rocketleague_rank/gold.png' },
                { id: 'platine', name: 'Platine', img: '/rocketleague_rank/platine.png' },
                { id: 'diamant', name: 'Diamant', img: '/rocketleague_rank/diamant.png' },
                { id: 'champion', name: 'Champion', img: '/rocketleague_rank/champion.webp' },
                { id: 'grandchampion', name: 'Grand Champion', img: '/rocketleague_rank/grand champion.png' },
            ],
            fortnite: [
                { id: 'bronze', name: 'Bronze', img: '/fortnite rank/bronze.webp' },
                { id: 'silver', name: 'Argent', img: '/fortnite rank/silver.png' },
                { id: 'gold', name: 'Or', img: '/fortnite rank/gold.webp' },
                { id: 'platine', name: 'Platine', img: '/fortnite rank/platine.png' },
                { id: 'diamant', name: 'Diamant', img: '/fortnite rank/diamant.webp' },
                { id: 'champion', name: 'Champion', img: '/fortnite rank/champion.webp' },
                { id: 'elite', name: 'Elite', img: '/fortnite rank/Elite_-_Icon_-_Fortnite.webp' },
                { id: 'unreal', name: 'Unreal', img: '/fortnite rank/unreal.webp' },
            ],
            warzone: [
                { id: 'bronze', name: 'Bronze', img: '/warzone_rank/bronze.png' },
                { id: 'silver', name: 'Silver', img: '/warzone_rank/silver.png' },
                { id: 'gold', name: 'Gold', img: '/warzone_rank/gold.png' },
                { id: 'platine', name: 'Platine', img: '/warzone_rank/platine.png' },
                { id: 'diamant', name: 'Diamant', img: '/warzone_rank/diamant.webp' },
                { id: 'crimson', name: 'Crimson', img: '/warzone_rank/crimson.png' },
                { id: 'iridescent', name: 'Iridescent', img: '/warzone_rank/iridescent.png' },
                { id: 'top250', name: 'Top 250', img: '/warzone_rank/250.webp' },
            ],
        };

        let userGameData = {
            rank: null,
            mainMode: null,
            options: [],
            mode: null,
            prefRanks: [],
            rankTolerance: 1,
            style: null
        };
        
        // NOUVEAU: Variables pour l'utilisateur actif
        let activeUsername = null;
        let activeUserId = null;

        // === MATCHMAKING REFACTORISÉ: Mapping rank → rank_level (SÉPARÉ PAR JEU) ===
        const RANK_LEVEL_MAPS = {
            valorant: {
                'fer1': 1, 'fer2': 2, 'fer3': 3,
                'bronze1': 4, 'bronze2': 5, 'bronze3': 6,
                'argent1': 7, 'argent2': 8, 'argent3': 9,
                'or1': 10, 'or2': 11, 'or3': 12,
                'platine1': 13, 'platine2': 14, 'platine3': 15,
                'diamant1': 16, 'diamant2': 17, 'diamant3': 18,
                'ascendant_1': 19, 'ascendant_2': 20, 'ascendant_3': 21,
                'immortal_1': 22, 'immortal_2': 23, 'immortal_3': 24,
                'radiant': 25
            },
            lol: {
                'iron': 1,
                'bronze': 2,
                'silver': 3,
                'gold': 4,
                'platinum': 5,
                'emerald': 6,
                'diamond': 7,
                'master': 8,
                'grandmaster': 9,
                'challenger': 10
            },
            csgo: {
                'silver': 1,
                'silver2': 2,
                'silver3': 3,
                'silver4': 4,
                'silver5': 5,
                'silver6': 6,
                'gold1': 7,
                'gold2': 8,
                'gold3': 9,
                'gold4': 10,
                'mg1': 11,
                'mg2': 12,
                'mge': 13,
                'dmg': 14,
                'le': 15,
                'lem': 16,
                'supreme': 17,
                'global': 18
            },
            rocketleague: {
                'bronze': 1,
                'silver': 2,
                'gold': 3,
                'platine': 4,
                'diamant': 5,
                'champion': 6,
                'grandchampion': 7
            },
            fortnite: {
                'bronze': 1,
                'silver': 2,
                'gold': 3,
                'platine': 4,
                'diamant': 5,
                'champion': 6,
                'elite': 7,
                'unreal': 8
            },
            warzone: {
                'bronze': 1,
                'silver': 2,
                'gold': 3,
                'platine': 4,
                'diamant': 5,
                'crimson': 6,
                'iridescent': 7,
                'top250': 8
            }
        };

        function getRankLevel(rankSlug, gameIdParam) {
            if (!rankSlug) return null;
            const normalized = rankSlug.toLowerCase().trim();
            const currentGameId = gameIdParam || gameId || 'valorant';
            const gameRanks = RANK_LEVEL_MAPS[currentGameId] || RANK_LEVEL_MAPS.valorant;
            return gameRanks[normalized] || null;
        }

        // Configuration de l'API - Utiliser l'API PHP locale sur Hostinger
        const API_BASE_URL = '';

        // Variables sociales/chat
        const activeChats = {};
        const friendsSidebar = document.getElementById('friendsSidebar');
        const chatContainer = document.getElementById('chat-container');
        const userPill = document.getElementById('connectedUsername');
        if (userPill) {
            const storedUsername = localStorage.getItem('username');
            console.log('📝 Username stocké:', storedUsername);
            console.log('📝 LocalStorage complet:', {
                username: localStorage.getItem('username'),
                user_id: localStorage.getItem('user_id'),
                token: localStorage.getItem('token') ? 'présent' : 'absent'
            });

            if (storedUsername && storedUsername !== 'undefined' && storedUsername !== 'null') {
                userPill.textContent = storedUsername;
            } else {
                // Si pas de username, vérifier si l'utilisateur est connecté
                const token = localStorage.getItem('token');
                if (!token) {
                    // Pas connecté, rediriger vers login
                    console.warn('⚠️ Pas de token, redirection vers login');
                    window.location.href = '/login.html';
                } else {
                    // Connecté mais pas de username, essayer de le récupérer
                    userPill.textContent = 'Chargement...';
                    fetchGameUserProfile();
                }
            }
        }

        // Fonction pour récupérer le profil utilisateur
        async function fetchGameUserProfile() {
            const token = localStorage.getItem('token');
            const userId = localStorage.getItem('user_id');

            if (!token || !userId) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/user/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const profile = await response.json();
                    if (profile.username) {
                        localStorage.setItem('username', profile.username);
                        const userPill = document.getElementById('connectedUsername');
                        if (userPill) {
                            userPill.textContent = profile.username;
                        }
                    }
                } else {
                    // Token invalide, rediriger vers login
                    console.warn('⚠️ Token invalide, redirection vers login');
                    localStorage.clear();
                    window.location.href = '/login.html';
                }
            } catch (error) {
                console.error('❌ Erreur récupération profil:', error);
            }
        }

        // Variables DOM
        const rankRangeInput = document.getElementById('rankRange');
        const rangeValueSpan = document.getElementById('rangeValue');
        const partnerSearchButton = document.getElementById('partnerSearchButton');
        const matchListDiv = document.getElementById('matchList');
        const styleToggle = document.getElementById('styleToggle');

        if (styleToggle) {
            styleToggle.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => selectStyle(btn.getAttribute('data-style')));
            });
        }


        // ====================================================
        // --- NOUVELLES FONCTIONS JWT UTILS ---
        // ====================================================

        /** Récupére l'en-téte d'autorisation JWT. */
        function getAuthHeader() {
            const token = localStorage.getItem('token');
            return token ? { 'Authorization': `Bearer ${token}` } : {};
        }

        /** Wrapper fetch pour les requétes protégées. */
        async function fetchProtected(url, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...getAuthHeader(),
                ...(options.headers || {})
            };

            // Construire l'URL complète avec l'API Railway
            const fullUrl = url.startsWith('http') ? url : `${API_BASE_URL}${url}`;

            const response = await fetch(fullUrl, {
                ...options,
                headers: headers,
            });

            // Gére l'expiration ou l'invalidité du token
            if (response.status === 401) {
                alert("Session expirée. Veuillez vous reconnecter.");
                localStorage.removeItem('token');
                localStorage.removeItem('username');
                window.location.href = '/login';
            }

            return response;
        }

        // ====================================================
        // --- Compteur de profils enregistr?s (temps r?el) ---
        // ====================================================
        async function refreshProfileCount() {
            const counterEl = document.getElementById('playerCount');
            if (!counterEl) return;

            try {
                const res = await fetchProtected('/api/stats/total-users');
                if (!res.ok) throw new Error('Reponse invalide');
                const data = await res.json();
                const count = data && typeof data.count === 'number' ? data.count : 0;
                counterEl.textContent = count.toLocaleString();
            } catch (error) {
                console.error('Erreur lors du chargement du nombre de profils:', error);
                counterEl.textContent = 'é';
            }
        }

        // ====================================================
        // --- 1. LOGIQUE D'AFFICHAGE DU JEU ---
        // ====================================================
        async function loadGameInfo() {
            console.log('Chargement des infos du jeu:', gameId);
            const info = gameInfo[gameId] || gameInfo.valorant;
            console.log('Info du jeu:', info);

            document.getElementById('gameTitle').textContent = info.title;
            document.getElementById('gameImg').src = info.img;
            document.getElementById('gameImg').alt = info.title;
            document.getElementById('playerCount').textContent = '...';
            await refreshProfileCount();
            if (!profileCountInterval) {
                profileCountInterval = setInterval(refreshProfileCount, 30000);
            }

            // Génération des modes principaux (radio)
            const mainModesHtml = info.mainModes.map((mode, index) => `
                <div class="radio-option">
                    <input type="radio" id="mode-main-${index}" name="gameMode" value="${mode}">
                    <label for="mode-main-${index}">${mode}</label>
                </div>
            `).join('');

            // Génération des options (checkbox)
            const optionsHtml = info.options.map((option, index) => `
                <div class="radio-option" style="margin-top: 10px;">
                    <input type="checkbox" id="mode-opt-${index}" name="gameOption" value="${option}">
                    <label for="mode-opt-${index}">${option}</label>
                </div>
            `).join('');

            const modeGroupElement = document.getElementById('modeGroup');
            if (modeGroupElement) {
                modeGroupElement.innerHTML = mainModesHtml + optionsHtml;
                console.log('? Modes générés:', info.mainModes);
                console.log('? Nombre de radios créés:', document.querySelectorAll('#modeGroup input[name="gameMode"]').length);

                // Attacher les événements pour les radios (modes principaux)
                modeGroupElement.querySelectorAll('input[name="gameMode"]').forEach(radio => {
                    radio.addEventListener('change', function() {
                        const mode = this.value;
                        console.log('Radio changé, mode sélectionné:', mode);
                        updateMainMode(mode);
                    });
                });

                // Attacher les événements pour les checkboxes (options)
                modeGroupElement.querySelectorAll('input[name="gameOption"]').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const option = this.value;
                        console.log('? Checkbox changé, option:', option, 'checked:', this.checked);
                        toggleOption(option);
                    });
                });

                console.log('? événements des modes/options attachés');
            } else {
                console.error('? Element modeGroup introuvable');
            }
        }

        // ====================================================
        // --- 2. LOGIQUE DES RANGS ET PRéFéRENCES ---
        // ====================================================

        function setupRankGrids(ranks) {
            const rankGrid = document.getElementById('rankGrid');
            const prefRankGrid = document.getElementById('prefRankGrid');

            if (!rankGrid || !prefRankGrid) return;

            // Rendu de la grille de rangs (Rang utilisateur)
            rankGrid.innerHTML = ranks.map(rank => `
                <div class="rank-option" data-rank-id="${rank.id}">
                    <img src="${rank.img}" alt="${rank.name}">
                    <span>${rank.name}</span>
                </div>
            `).join('');

            // Rendu de la grille de préférences (Rangs du partenaire)
            prefRankGrid.innerHTML = ranks.map(rank => `
                <div class="rank-option" data-pref-rank-id="${rank.id}">
                    <img src="${rank.img}" alt="${rank.name}">
                    <span>${rank.name}</span>
                </div>
            `).join('');

            // Attacher les événements avec addEventListener (Rang utilisateur)
            rankGrid.querySelectorAll('.rank-option').forEach(option => {
                option.addEventListener('click', function() {
                    const rankId = this.getAttribute('data-rank-id');
                    console.log('Clic détecté sur le rang:', rankId);
                    selectRank(rankId);
                });
            });

            // Attacher les événements avec addEventListener (Rangs préférés)
            prefRankGrid.querySelectorAll('.rank-option').forEach(option => {
                option.addEventListener('click', function() {
                    const rankId = this.getAttribute('data-pref-rank-id');
                    console.log('Clic détecté sur le rang préféré:', rankId);
                    togglePrefRank(rankId);
                });
            });

            console.log('? événements de clic attachés pour', ranks.length, 'rangs');
        }

        window.selectRank = (rankId) => {
            console.log('Sélection du rang:', rankId);
            userGameData.rank = rankId;
            document.querySelectorAll('#rankGrid .rank-option').forEach(el => {
                el.classList.toggle('active', el.getAttribute('data-rank-id') === rankId);
            });
            document.getElementById('userRankDisplay').textContent = RANKS[gameId.toLowerCase()].find(r => r.id === rankId)?.name || 'Non défini';
            console.log('? Rang mis à jour dans userGameData:', userGameData);
        };

        window.togglePrefRank = async (rankId) => {
            const index = userGameData.prefRanks.indexOf(rankId);
            if (index > -1) {
                userGameData.prefRanks.splice(index, 1);
            } else {
                userGameData.prefRanks.push(rankId);
            }
            document.querySelectorAll('#prefRankGrid .rank-option').forEach(el => {
                el.classList.toggle('active', userGameData.prefRanks.includes(el.getAttribute('data-pref-rank-id')));
            });
            // Sauvegarde immédiate des préférences lors du changement de rangs préférés
            await savePartnerPreferences();
        };

        window.updateMainMode = (mode) => {
            console.log('Sélection du mode:', mode);
            userGameData.mainMode = mode;
            updateModeDisplay();
            console.log('? Mode mis à jour dans userGameData:', userGameData);
        };

        window.toggleOption = (option) => {
            if (!userGameData.options) userGameData.options = [];
            const index = userGameData.options.indexOf(option);
            
            if (index > -1) {
                userGameData.options.splice(index, 1); 
            } else {
                userGameData.options.push(option); 
            }
            
            updateModeDisplay();
        };

        function selectStyle(style) {
            userGameData.style = style;
            document.querySelectorAll('#styleToggle button').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-style') === style);
            });
        }

        
        // Fonction utilitaire pour mettre à jour l'affichage dans la colonne de gauche
        function updateModeDisplay() {
            let display = userGameData.mainMode || 'Non défini';
            if (userGameData.options && userGameData.options.length > 0) {
                 display += ` (+ ${userGameData.options.join(', ')})`;
            }
            userGameData.mode = display; 
            document.getElementById('gameModeDisplay').textContent = display;
        }

        // événement pour la tolérance de rang
        if (rankRangeInput) {
            rankRangeInput.addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                userGameData.rankTolerance = value;
                const display = value === 0 ? 'Exact' : (value === 1 ? 'é1 Rang' : `é${value} Rangs`);
                rangeValueSpan.textContent = display;
                document.getElementById('rankRangeDisplay').textContent = display;
                
                // Sauvegarde immédiate de la tolérance (optionnel, mais pratique)
                savePartnerPreferences();
            });
        }


        // ====================================================
        // --- 3. PERSISTENCE & SAUVEGARDE (API) ---
        // ====================================================

        /** Charge le profil complet de l'utilisateur depuis le serveur. */
        async function loadProfileAndSettings() {
            console.log('Chargement du profil pour gameId:', gameId);
            const response = await fetchProtected('/api/user/profile?gameId=' + gameId);

            console.log('Réponse API status:', response.status, response.statusText);

            if (!response.ok) {
                console.warn('Impossible de charger le profil utilisateur. Status:', response.status);
                console.warn('Cela peut étre normal si c\'est votre premiére visite sur ce jeu.');
                return;
            }

            const profile = await response.json();
            const settings = profile.gameSettings;
            const prefs = profile.partnerPreferences;
            
            // NOUVEAU: Stockage de l'ID utilisateur
            activeUserId = profile.id;
            activeUsername = profile.username;

            // Mise à jour de userGameData
            userGameData.rank = settings.rank;
            userGameData.mainMode = settings.mainMode;
            userGameData.options = settings.options || [];
            userGameData.style = settings.style || null;
            userGameData.prefRanks = prefs.prefRanks || [];
            userGameData.rankTolerance = prefs.rankTolerance || 1;
            
            // --- Application à l'interface ---
            
            // 1. Rang
            if (settings.rank) {
                selectRank(settings.rank); 
            }

            // 2. Mode principal (Radio)
            if (settings.mainMode) {
                const modeInput = document.querySelector(`#modeGroup input[name="gameMode"][value="${settings.mainMode}"]`);
                if (modeInput) modeInput.checked = true;
            }

            // 3. Options (Checkbox)
            if (Array.isArray(settings.options)) {
                 settings.options.forEach(option => {
                    const optionInput = document.querySelector(`#modeGroup input[name="gameOption"][value="${option}"][type="checkbox"]`);
                    if (optionInput) optionInput.checked = true;
                 });
            }
            
            updateModeDisplay(); 

            // 4. Tolérance de rang
            if (rankRangeInput && prefs.rankTolerance !== undefined) {
                rankRangeInput.value = prefs.rankTolerance;
                rankRangeInput.dispatchEvent(new Event('input')); 
            }
            
            if (userGameData.style) {
                selectStyle(userGameData.style);
            }
            
            // 5. Rangs préférés
            if (Array.isArray(prefs.prefRanks)) {
                // Bascule de l'état "active" pour chaque rang préféré
                document.querySelectorAll('#prefRankGrid .rank-option').forEach(el => {
                    el.classList.toggle('active', prefs.prefRanks.includes(el.getAttribute('data-pref-rank-id')));
                });
            }
        }

        /** Sauvegarde des settings de jeu (Rang/Mode/Options) - REFACTORISÉ */
        window.saveGameSettings = async () => {
            console.log('saveGameSettings appelée', userGameData);

            if (!userGameData.rank || !userGameData.mainMode) {
                console.error('❌ Rang ou mode manquant:', {rank: userGameData.rank, mainMode: userGameData.mainMode});
                alert("Veuillez sélectionner votre rang et votre mode de jeu.");
                return;
            }

            // Calculer le rank_level (avec gameId)
            console.log('🔍 Vérification du rang:', {
                rank: userGameData.rank,
                gameId: gameId,
                availableRanks: RANK_LEVEL_MAPS[gameId] ? Object.keys(RANK_LEVEL_MAPS[gameId]) : 'gameId non trouvé'
            });

            const rankLevel = getRankLevel(userGameData.rank, gameId);
            console.log('📊 Résultat getRankLevel:', rankLevel);

            if (rankLevel === null) {
                console.error('❌ Rang invalide:', userGameData.rank, 'pour le jeu:', gameId);
                console.error('❌ RANK_LEVEL_MAPS disponibles:', Object.keys(RANK_LEVEL_MAPS));
                console.error('❌ Rangs valides pour', gameId, ':', RANK_LEVEL_MAPS[gameId]);
                alert('Erreur: rang invalide pour ce jeu');
                return;
            }

            // Nouveau payload selon la spécification
            const profilePayload = {
                rank: userGameData.rank,
                rank_level: rankLevel,
                mode: userGameData.mainMode,
                style: userGameData.style || '',
                tolerance: userGameData.rankTolerance || 1,
                options: userGameData.options || []
            };

            console.log('💾 Sauvegarde du profil:', profilePayload);

            try {
                // Utiliser le paramètre GET directement (la route .htaccess ne fonctionne pas toujours)
                const response = await fetchProtected(`/api/profile.php?game=${gameId}`, {
                    method: 'POST',
                    body: JSON.stringify(profilePayload)
                });

                console.log('📡 Réponse sauvegarde:', response.status, response.statusText);

                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ Profil sauvegardé:', result);
                    alert('Paramètres de jeu sauvegardés !');
                } else if (response.status !== 401) {
                    const error = await response.json().catch(() => ({}));
                    console.error('❌ Erreur sauvegarde:', response.status, error);
                    alert(error.error || "Erreur lors de la sauvegarde des paramètres de jeu.");
                }
            } catch (error) {
                console.error('❌ Exception sauvegarde:', error);
                alert("Erreur réseau lors de la sauvegarde.");
            }
        };

        /** Sauvegarde des préférences de partenaire (Rangs Préférés/Tolérance) */
        async function savePartnerPreferences() {
             const prefsPayload = {
                game: gameId,
                prefRanks: userGameData.prefRanks,
                rankTolerance: userGameData.rankTolerance
             };

             const prefsRes = await fetchProtected('/api/game/preferences.php', {
                method: 'POST',
                body: JSON.stringify(prefsPayload)
            });

            if (prefsRes.ok) {
                // Confirmation discréte
            } else if (prefsRes.status !== 401) {
                console.error("Erreur lors de la sauvegarde des préférences de partenaire.");
            }
        }
        
        // ====================================================
        // --- 4. LOGIQUE DE RECHERCHE DE PARTENAIRE (SERVEUR) ---
        // ====================================================

        window.toggleSearch = async () => {
            console.log('Recherche de partenaire lancée', userGameData);

            if (!userGameData.rank || !userGameData.mainMode) {
                console.warn('Rang ou mode non défini', {rank: userGameData.rank, mode: userGameData.mainMode});
                alert("Veuillez définir votre rang et votre mode de jeu avant de lancer la recherche.");
                return;
            }

            // Désactiver le bouton pendant la recherche
            partnerSearchButton.disabled = true;
            partnerSearchButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i> <span>Recherche en cours...</span>`;
            partnerSearchButton.style.opacity = '0.6';
            partnerSearchButton.style.cursor = 'not-allowed';

            console.log('? Paramétres OK, lancement de la recherche');

            // Une seule recherche
            await fetchMatches();

            // Réactiver le bouton aprés la recherche
            partnerSearchButton.disabled = false;
            partnerSearchButton.innerHTML = `<i class="fas fa-search"></i> <span>Rechercher un partenaire</span>`;
            partnerSearchButton.style.opacity = '1';
            partnerSearchButton.style.cursor = 'pointer';

            console.log('? Recherche terminée');
        };

        /** Récupére les matchs depuis l'API serveur - REFACTORISÉ */
        async function fetchMatches() {
            console.log('🔍 Recherche de partenaires sur le serveur...');

            try {
                // Utiliser la route legacy (la nouvelle route .htaccess fonctionne aussi)
                const response = await fetchProtected(`/api/match/search.php?game=${gameId}`);

                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ Résultats reçus:', result);
                    renderMatches(result.matches || []);
                } else if (response.status !== 401) {
                    // Erreur côté serveur
                    partnerSearchButton.innerHTML = `<i class="fas fa-search"></i> <span>Rechercher un partenaire</span>`;
                    partnerSearchButton.classList.remove('searching');
                    userGameData.isSearching = false;
                    renderMatches([]);

                    try {
                        const err = await response.json();
                        console.error('❌ Erreur recherche:', err);
                        alert("Erreur de recherche : " + (err.error || err.message || "Veuillez configurer votre profil de jeu."));
                    } catch {
                        alert("Erreur de recherche. Serveur injoignable.");
                    }
                }
            } catch (error) {
                console.error('❌ Exception recherche:', error);
                partnerSearchButton.innerHTML = `<i class="fas fa-search"></i> <span>Rechercher un partenaire</span>`;
                partnerSearchButton.classList.remove('searching');
                userGameData.isSearching = false;
                renderMatches([]);
                alert("Erreur réseau lors de la recherche.");
            }
        }

        function renderMatches(matches) {
            console.log('🎨 renderMatches appelé avec', matches.length, 'résultats');
            console.log('🔍 matchListDiv existe?', !!matchListDiv);

            document.getElementById('matchCount').textContent = matches.length.toString();
            if (!matchListDiv) {
                console.error('❌ matchListDiv est null - élément DOM manquant!');
                return;
            }

            if (matches.length === 0) {
                console.log('⚠️ Aucun résultat - affichage du message');
                matchListDiv.innerHTML = `<p style="color:var(--text-muted); text-align:center; padding: 20px; background: var(--bg-card); border-radius: 8px;">Aucun partenaire trouvé avec ces critéres. Essayez de modifier votre tolérance de rang ou vos préférences.</p>`;
                return;
            }

            console.log('✅ Génération du HTML pour', matches.length, 'matchs');
            const matchHtml = matches.map(match => {
                const gameRanks = RANKS[gameId.toLowerCase()] || [];
                const rankInfo = gameRanks.find(r => r.id === match.rank) || { name: 'Non classé', img: '' };

                // Construire l'affichage du mode avec options
                // FIX: L'API retourne 'mode' pas 'mainMode'
                let modeDisplay = match.mode || match.mainMode || 'Non défini';
                if (match.options && match.options.length > 0) {
                    modeDisplay += ` (${match.options.join(', ')})`;
                }

                // Affichage du style
                const styleDisplay = match.style ? `<span style="color: #4caf50;">é ${match.style}</span>` : '';

                // Icône vocal
                const hasVocal = match.voiceChat === true;
                const vocalIcon = hasVocal ? '<i class="fas fa-microphone" title="Vocal obligatoire" style="color: #4caf50; margin-left: 8px;"></i>' : '';

                return `
                    <div class="match-card">
                        <div class="match-info">
                            <img src="${rankInfo.img}" alt="${rankInfo.name}" class="match-rank-img">
                            <div>
                                <div class="match-username">${match.username} ${vocalIcon}</div>
                                <div class="match-details">Rang: ${rankInfo.name} | Mode: ${modeDisplay} ${styleDisplay}</div>
                            </div>
                        </div>
                        <div class="match-actions">
                            <button class="send-msg-match" data-username="${match.username}"><i class="fas fa-comment"></i> Message</button>
                            <button class="add-friend-match" data-username="${match.username}"><i class="fas fa-user-plus"></i> Ami</button>
                            <button class="report-user-match" data-username="${match.username}" style="background: #ef5350;" title="Signaler cet utilisateur"><i class="fas fa-exclamation-triangle"></i></button>
                        </div>
                    </div>
                `;
            }).join('');

            console.log('📝 Injection du HTML dans matchListDiv (longueur:', matchHtml.length, 'caractères)');
            matchListDiv.innerHTML = matchHtml;
            console.log('✅ HTML injecté - matchListDiv.children.length:', matchListDiv.children.length);

            // Attacher les événements avec addEventListener
            matchListDiv.querySelectorAll('.send-msg-match').forEach(btn => {
                btn.addEventListener('click', function() {
                    const username = this.getAttribute('data-username');
                    console.log('Ouverture du chat avec:', username);
                    openChat(username);
                });
            });

            matchListDiv.querySelectorAll('.add-friend-match').forEach(btn => {
                btn.addEventListener('click', function() {
                    const username = this.getAttribute('data-username');
                    console.log('Envoi demande d\'ami é:', username);
                    sendFriendRequest(username);
                });
            });

            matchListDiv.querySelectorAll('.report-user-match').forEach(btn => {
                btn.addEventListener('click', function() {
                    const username = this.getAttribute('data-username');
                    console.log('Signalement de:', username);
                    window.openReportModal(username);
                });
            });
        }
        
        // CORRIGé: Utilise /api/friends/send et le bon payload
        window.sendFriendRequest = async (username) => {
            const res = await fetchProtected('/api/friends/send', {
                method:'POST',
                body:JSON.stringify({receiverUsername:username})
            });
            const d = await res.json();
            alert(d.message || d.error || `Demande d'ami envoyée à ${username} !`);
            loadSocial(); // Rafraîchit la sidebar
        };


// ----------------------------------------------------------------
// --- LOGIQUE SOCIALE (Mise à jour pour JWT et harmonisation) ---
// ----------------------------------------------------------------

// ====================================================
// --- 1. FONCTION DE BASCULE DE LA SIDEBAR (Amis) ---
// ====================================================
window.toggleSidebar = function() {
    const friendsSidebar = document.getElementById('friendsSidebar');
    if (!friendsSidebar) return;
    const isActive = friendsSidebar.classList.toggle('active');
    const toggleBtn = document.querySelector('.toggle-friends-btn');

    if (toggleBtn) toggleBtn.classList.toggle('active', isActive);

    // Si la sidebar est fermée, on ferme aussi tous les chats actifs.
    if (!isActive) {
        if (typeof activeChats !== 'undefined' && typeof closeChat === 'function') {
            Object.keys(activeChats).forEach(closeChat);
        }
    }

    localStorage.setItem('socialSidebarActive', isActive);
};

// ====================================================
// --- 2. LOGIQUE SOCIALE (Amis/Requests) ---
// ====================================================

// Fonction pour mettre à jour le badge de notification du bouton Amis
function updateFriendsNotificationBadge() {
    const badge = document.getElementById('friendsNotificationBadge');
    if (!badge) return;

    // Compter les demandes d'amis reéues
    const receivedCount = parseInt(document.getElementById('receivedCount')?.textContent || '0');

    // Compter les messages non lus
    const unreadMessagesCount = window.ChatManager ? window.ChatManager.getTotalUnreadCount() : 0;

    // Total
    const totalNotifications = receivedCount + unreadMessagesCount;

    if (totalNotifications > 0) {
        badge.textContent = totalNotifications > 99 ? '99+' : totalNotifications;
        badge.classList.add('active');
    } else {
        badge.classList.remove('active');
    }
}

// CORRIGé: Appel à la seule route /api/friends
async function loadSocial() {
    try {
        const fRes = await fetchProtected('/api/friends'); 
        
        if (!fRes.ok) {
            throw new Error("Erreur de récupération des données sociales.");
        }
        
        const fData = await fRes.json();

        if (userPill) {
            const name =
                (fData.currentUser && fData.currentUser.username) ||
                localStorage.getItem('username') ||
                'Utilisateur';
            userPill.textContent = name;
        }

        // Le serveur retourne un objet avec les 3 listes
        renderFriends(fData.friends || []);
        renderRequests(fData.incomingRequests || []);
        renderSent(fData.outgoingRequests || []);

        // Mettre à jour le badge de notification
        updateFriendsNotificationBadge();

    } catch (e) {
        renderFriends([]);
        renderRequests([]); 
        renderSent([]); 
        console.error("Erreur chargement social:", e);
    }
}

function renderFriends(list) {
    const c = document.getElementById('friendsList');
    if (!c) return;
    c.innerHTML = "";
    const countSpan = document.getElementById('friendsCount');
    if(countSpan) countSpan.textContent = list.length;

    if (!list.length) {
        c.innerHTML = `<p style="text-align:center; color:var(--text-muted); font-size:0.9rem;">Ajoutez des amis !</p>`;
        return;
    }

    list.forEach(f => {
        const d = document.createElement('div');
        d.className = 'friend-card';

        // Vérifier si cet ami a des messages non lus
        const unreadCount = window.ChatManager ? window.ChatManager.getUnreadCount(f.username) : 0;

        d.innerHTML = `
            <div style="display: flex; align-items: center; flex: 1; cursor: pointer;" class="friend-card-content">
                <div class="friend-avatar">${f.username.charAt(0).toUpperCase()}</div>
                <span>${f.username}</span>
            </div>
            ${unreadCount > 0 ? `<span class="friend-card-badge" id="badge-${f.username}">${unreadCount}</span>` : ''}
            <button type="button" class="report-friend-btn" data-username="${f.username}" style="min-width:32px; width: 32px; height: 32px; display:flex; align-items:center; justify-content:center; background: transparent; border: 1px solid #ffa726; color: #ffa726; border-radius: 50%; cursor: pointer; transition: all 0.2s; margin-right: 5px;" title="Signaler cet utilisateur">
                <i class="fas fa-exclamation-triangle"></i>
            </button>
            <button type="button" class="action-btn reject remove-friend-btn" data-username="${f.username}" style="min-width:32px; width: 32px; height: 32px; display:flex; align-items:center; justify-content:center; background: transparent; border: 1px solid #ef4444; color: #ef4444; border-radius: 50%; cursor: pointer; transition: all 0.2s;" title="Supprimer cet ami">
                <i class="fas fa-times"></i>
            </button>
        `;

        // Ajouter le gestionnaire de clic pour ouvrir le chat sur le contenu de la carte
        const contentDiv = d.querySelector('.friend-card-content');
        if (contentDiv) {
            contentDiv.addEventListener('click', () => {
                console.log('Ouverture du chat avec:', f.username);
                openChat(f.username);
            });
        }

        // Ajouter le gestionnaire pour le bouton de signalement
        const reportBtn = d.querySelector('.report-friend-btn');
        if (reportBtn) {
            reportBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                const username = reportBtn.dataset.username;
                console.log('Signalement de:', username);
                window.openReportModal(username);
            });
        }

        // Ajouter le gestionnaire pour le bouton de suppression
        const removeBtn = d.querySelector('.remove-friend-btn');
        if (removeBtn) {
            removeBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                e.preventDefault();
                const username = removeBtn.dataset.username;
                if (confirm(`Voulez-vous vraiment supprimer ${username} de vos amis ?`)) {
                    await removeFriend(username);
                }
            });
        }

        c.appendChild(d);
    });
}

// CORRIGé: Utilise le username du sender dans l'onclick
function renderRequests(list) {
    const c = document.getElementById('requestsList');
    if (!c) return;
    c.innerHTML = "";
    const countSpan = document.getElementById('receivedCount');
    if(countSpan) countSpan.textContent = list.length;
    const title = document.getElementById('receivedRequestsTitle');
    if(title) title.style.display = list.length ? 'block' : 'none';

    list.forEach(r => {
        const d = document.createElement('div');
        d.className = 'friend-card';
        d.innerHTML = `
            <div style="display: flex; align-items: center; flex-grow: 1;">
                <div class="friend-avatar">${r.username.charAt(0).toUpperCase()}</div>
                <span>${r.username}</span>
            </div>
            <div class="request-actions" style="display:flex; gap:5px;">
                <button type="button" class="action-btn accept request-action-btn" data-username="${r.username}" data-action="accept"><i class="fas fa-check"></i></button>
                <button type="button" class="action-btn reject request-action-btn" data-username="${r.username}" data-action="reject"><i class="fas fa-times"></i></button>
            </div>
        `;
        c.appendChild(d);
    });
}

// CORRIGé: Simplification (retrait du bouton 'reject' qui n'est pas supporté par l'API pour les requétes envoyées)
function renderSent(list) {
    const c = document.getElementById('sentList');
    if (!c) return;
    c.innerHTML = "";
    const countSpan = document.getElementById('sentCount');
    if(countSpan) countSpan.textContent = list.length;
    const title = document.getElementById('sentRequestsTitle');
    if(title) title.style.display = list.length ? 'block' : 'none';

    list.forEach(r => {
        const d = document.createElement('div');
        d.className = 'friend-card';
        d.style.opacity = 0.7; 
        d.innerHTML = `
            <div style="display: flex; align-items: center; flex-grow: 1;">
                <div class="friend-avatar">${r.username.charAt(0).toUpperCase()}</div>
                <span style="font-style:italic;">${r.username} (En attente)</span>
            </div>
        `;
        c.appendChild(d);
    });
}

// Délégation des clics sur accepter/refuser
const requestsListEl = document.getElementById('requestsList');
if (requestsListEl) {
    requestsListEl.addEventListener('click', (e) => {
        const btn = e.target.closest('.request-action-btn');
        if (!btn) return;
        const username = btn.dataset.username;
        const action = btn.dataset.action;
        hReq(e, username, action);
    });
}

// Gére l'envoi de la demande d'ami
const addFriendForm = document.getElementById('add-friend-form');
if (addFriendForm) {
    addFriendForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const input = document.getElementById('friend-input');
        const friendNotif = document.getElementById('friend-notif');

        if (!input.value.trim()) {
            friendNotif.innerText = "Veuillez entrer un pseudo.";
            friendNotif.style.color = "#ef4444";
            setTimeout(()=>friendNotif.innerText="",3000);
            return;
        }

        // Vérifier que l'utilisateur est connecté
        if (!localStorage.getItem('token')) {
            friendNotif.innerText = "Vous devez être connecté.";
            friendNotif.style.color = "#ef4444";
            setTimeout(() => {
                window.location.href = '/login';
            }, 2000);
            return;
        }

        try {
            console.log("Envoi demande ami à:", input.value.trim());
            // CORRIGÉ: URL et Payload mis à jour
            const res = await fetchProtected('/api/friends/send', {
                method:'POST',
                body:JSON.stringify({receiverUsername:input.value.trim()})
            });

            if (!res) {
                friendNotif.style.color = "#ef4444";
                friendNotif.innerText = "Session expirée. Reconnectez-vous.";
                setTimeout(()=>friendNotif.innerText="",3000);
                return;
            }

            // Vérifier le type de contenu
            const contentType = res.headers.get('content-type');
            console.log("Status:", res.status, "Content-Type:", contentType);
            if (!contentType || !contentType.includes('application/json')) {
                console.error("Réponse non-JSON reçue. Status:", res.status, "Content-Type:", contentType);
                const text = await res.text();
                console.error("Contenu de la réponse:", text.substring(0, 200));
                friendNotif.style.color = "#ef4444";
                if (res.status === 401) {
                    friendNotif.innerText = "Session expirée. Reconnectez-vous.";
                } else if (res.status === 404) {
                    friendNotif.innerText = "Utilisateur introuvable.";
                } else if (res.status >= 500) {
                    friendNotif.innerText = "Erreur serveur (code " + res.status + ")";
                } else {
                    friendNotif.innerText = "Erreur (code " + res.status + ")";
                }
                setTimeout(()=>friendNotif.innerText="",5000);
                return;
            }

            const d = await res.json();

            if (res.ok) {
                friendNotif.style.color = "var(--primary-color)";
                friendNotif.innerText = d.message || "Demande envoyée !";
                input.value = "";
                loadSocial();
            } else {
                friendNotif.style.color = "#ef4444";
                friendNotif.innerText = d.error || d.message || "Erreur lors de l'envoi.";
            }
            setTimeout(()=>friendNotif.innerText="",5000);
        } catch (err) {
            console.error("Erreur ajout ami:", err);
            friendNotif.style.color = "#ef4444";
            if (err.message && err.message.includes('JSON')) {
                friendNotif.innerText = "Session expirée. Reconnectez-vous.";
            } else {
                friendNotif.innerText = "Erreur de connexion au serveur.";
            }
            setTimeout(()=>friendNotif.innerText="",5000);
        }
    });
}

// CORRIGé: Gére l'acceptation/rejet d'une demande d'ami entrante (utilise le username du sender)
window.hReq = async(event, username, action) => { 
    if (event && typeof event.stopPropagation === 'function') {
        event.stopPropagation();
        event.preventDefault();
    }
    const btn = event?.currentTarget || event?.target?.closest?.('.request-action-btn');
    if (btn) btn.disabled = true;
    const card = btn?.closest?.('.friend-card');
    if (card) card.classList.add('processing');
    const statusEl = document.getElementById('friend-notif');
    if (statusEl) {
        statusEl.style.color = '#22c55e';
        statusEl.innerText = 'Traitement...';
    }

    try {
        // Seul l'accept/reject des requétes entrantes est géré par /api/friends/respond
        if (action === 'accept' || action === 'reject') {
            const payload = { 
                senderUsername: username, 
                action: action
            };
            
            const res = await fetchProtected('/api/friends/respond', {
                method:'POST',
                body:JSON.stringify(payload)
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) {
                if (statusEl) {
                    statusEl.style.color = '#ef4444';
                    statusEl.innerText = data.error || "Erreur lors de l'action sur la demande d'ami.";
                } else {
                    alert(data.error || "Erreur lors de l'action sur la demande d'ami.");
                }
                return;
            }
            if (statusEl) {
                statusEl.style.color = '#22c55e';
                statusEl.innerText = data.message || (action === 'accept' ? 'Ami ajouté.' : 'Demande refusée.');
            }
            if (card) card.remove();
        }

        await loadSocial(); 
    } catch (e) {
        console.error('Erreur hReq:', e);
        if (statusEl) {
            statusEl.style.color = '#ef4444';
            statusEl.innerText = "Impossible de traiter la demande pour l'instant.";
        } else {
            alert("Impossible de traiter la demande pour l'instant.");
        }
    } finally {
        if (btn) btn.disabled = false;
        if (card) card.classList.remove('processing');
    }
};

// Fonction pour supprimer un ami
async function removeFriend(username) {
    try {
        const res = await fetchProtected('/api/friends/remove', {
            method: 'DELETE',
            body: JSON.stringify({ friendUsername: username })
        });

        if (res.ok) {
            const data = await res.json();
            const statusEl = document.getElementById('friend-notif');
            if (statusEl) {
                statusEl.style.color = '#22c55e';
                statusEl.innerText = data.message || `${username} a été retiré de vos amis.`;
                setTimeout(() => statusEl.innerText = "", 3000);
            }
            // Fermer le chat s'il est ouvert
            if (activeChats[username]) {
                closeChat(username);
            }
            await loadSocial();
        } else {
            const error = await res.json();
            alert(error.message || "Erreur lors de la suppression de l'ami.");
        }
    } catch (error) {
        console.error('Erreur suppression ami:', error);
        alert("Impossible de supprimer cet ami pour l'instant.");
    }
}

// ====================================================
// --- 3. LOGIQUE DE CHAT (synchronisée via ChatManager) ---
// ====================================================
function updateChatUI(username) {
    const chatBody = document.getElementById(`msg-${username}`);
    if (!chatBody || !window.ChatManager) return;

    const messages = window.ChatManager.getMessagesWithUser(username);
    const isScrolledToBottom = chatBody.scrollHeight - chatBody.clientHeight <= chatBody.scrollTop + 1;

    chatBody.innerHTML = messages.map(msg => {
        const isOwn = window.ChatManager.isOwnMessage(msg);
        return `
            <div class="msg ${isOwn ? 'self' : 'other'}">
                ${msg.content}
            </div>
        `;
    }).join('');

    if (isScrolledToBottom || messages.length <= 1) {
        chatBody.scrollTop = chatBody.scrollHeight;
    }
}

window.openChat = (username) => {
    console.log('openChat appelée pour:', username);
    console.log('ChatManager disponible:', !!window.ChatManager);
    console.log('globalChatManager disponible:', !!window.globalChatManager);
    console.log('chatContainer disponible:', !!chatContainer);

    if(document.getElementById(`cw-${username}`)) {
        console.log('Chat déjé ouvert pour:', username);
        return;
    }

    // Utiliser globalChatManager si ChatManager n'est pas disponible
    if (!window.ChatManager && window.globalChatManager) {
        console.log('Utilisation de globalChatManager à la place');
        window.ChatManager = window.globalChatManager;
    }

    if (!window.ChatManager) {
        console.error('? ChatManager non disponible !');
        console.error('window.ChatManager:', window.ChatManager);
        console.error('window.globalChatManager:', window.globalChatManager);
        alert('Erreur: Le systéme de chat n\'est pas initialisé. Veuillez recharger la page.');
        return;
    }

    if (!chatContainer) {
        console.error('? chatContainer non trouvé !');
        return;
    }

    const chatWindow = document.createElement('div');
    chatWindow.className = 'chat-window';
    chatWindow.id = `cw-${username}`;

    chatWindow.innerHTML = `
        <div class="chat-header" data-close-chat="${username}">
            <span>${username}</span>
            <span><i class="fas fa-times"></i></span>
        </div>
        <div class="chat-body" id="msg-${username}"></div>
        <form class="chat-input-area" data-username="${username}">
            <input type="text" placeholder="écrire un message..." autocomplete="off">
            <button type="submit"><i class="fas fa-paper-plane"></i></button>
        </form>
    `;

    chatContainer.appendChild(chatWindow);
    console.log('? Chat window créée pour:', username);

    window.ChatManager.registerActiveChat(username);
    activeChats[username] = true;

    const form = chatWindow.querySelector('.chat-input-area');
    if (form) {
        form.addEventListener('submit', (evt) => {
            evt.preventDefault();
            sendMessage(evt, username);
        });
    }

    const header = chatWindow.querySelector('[data-close-chat]');
    if (header) {
        header.addEventListener('click', () => closeChat(username));
    }

    const updateCallback = () => updateChatUI(username);
    window.ChatManager.subscribe(updateCallback);

    if (!activeChats[username + '_callback']) {
        activeChats[username + '_callback'] = updateCallback;
    }

    updateChatUI(username);

    // Marquer les messages comme lus
    window.ChatManager.markAsRead(username);

    // Mettre à jour les badges
    updateFriendsNotificationBadge();

    // Rafraîchir l'affichage des amis pour mettre à jour les badges individuels
    loadSocial();

    console.log('? Chat complétement initialisé pour:', username);
};

window.closeChat = (username) => {
    const el = document.getElementById(`cw-${username}`);
    if(el) el.remove();

    if (window.ChatManager) {
        window.ChatManager.unregisterActiveChat(username);

        const callback = activeChats[username + '_callback'];
        if (callback) {
            window.ChatManager.unsubscribe(callback);
            delete activeChats[username + '_callback'];
        }
    }

    delete activeChats[username];
};

window.sendMessage = async (e, username) => {
    e.preventDefault();
    const input = e.target.querySelector('input');
    if (!input || !input.value.trim() || !window.ChatManager) return;

    const result = await window.ChatManager.sendMessage(username, input.value.trim());
    if (result.success) {
        input.value = "";
        updateChatUI(username);
    } else {
        console.error('Erreur envoi message:', result.error);
        alert('Erreur lors de l\'envoi du message');
    }
};

// ====================================================
// --- 5. INITIALISATION FINALE ---
// ====================================================
(async function() {
    // SafeMates latérale : peupler les jeux et activer les menus
    (function setupSideNav() {
        document.querySelectorAll('.nav-toggle').forEach(btn => {
            const target = document.getElementById(btn.dataset.target);
            if (!target) return;
            btn.addEventListener('click', () => {
                btn.classList.toggle('open');
                target.classList.toggle('open');
            });
            if (btn.dataset.target === 'navLinks') btn.classList.add('open');
        });
        const linksList = document.getElementById('navLinks');
        if (linksList) linksList.classList.add('open');
    })();

    // Bouton amis (sécurité si l'onclick est bloqué)
    const toggleBtn = document.querySelector('.toggle-friends-btn');
    if (toggleBtn) {
        toggleBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            toggleSidebar();
        });
    }

    // === MENU MOBILE ===
    const mobileMenuToggle = document.getElementById('mobileMenuToggle');
    const mobileOverlay = document.getElementById('mobileOverlay');
    const sideNav = document.getElementById('sideNav');

    if (mobileMenuToggle && mobileOverlay && sideNav) {
        // Ouvrir/Fermer le menu
        mobileMenuToggle.addEventListener('click', function() {
            sideNav.classList.toggle('mobile-active');
            mobileOverlay.classList.toggle('active');

            // Changer l'icône
            const icon = this.querySelector('i');
            if (sideNav.classList.contains('mobile-active')) {
                icon.classList.remove('fa-bars');
                icon.classList.add('fa-times');
            } else {
                icon.classList.remove('fa-times');
                icon.classList.add('fa-bars');
            }
        });

        // Fermer en cliquant sur l'overlay
        mobileOverlay.addEventListener('click', function() {
            sideNav.classList.remove('mobile-active');
            mobileOverlay.classList.remove('active');
            const icon = mobileMenuToggle.querySelector('i');
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
        });

        // Fermer en cliquant sur un lien
        sideNav.querySelectorAll('a.nav-link').forEach(link => {
            link.addEventListener('click', function() {
                if (window.innerWidth <= 768) {
                    sideNav.classList.remove('mobile-active');
                    mobileOverlay.classList.remove('active');
                    const icon = mobileMenuToggle.querySelector('i');
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-bars');
                }
            });
        });
    }

    // Vérifie le token (redirection automatique par fetchProtected si absent/expiré)
    if (!localStorage.getItem('token')) {
        window.location.href = '/login';
        return;
    }
    
    // Initialisation des grilles de rangs
    const gameRanks = RANKS[gameId.toLowerCase()] || RANKS.valorant;
    setupRankGrids(gameRanks); 

    // Chargement des données
    await loadGameInfo();
    await loadProfileAndSettings(); // Charge les données du serveur (et l'ID utilisateur)

    // Attacher les événements des boutons avec addEventListener
    const saveSettingsBtn = document.getElementById('saveSettingsBtn');
    if (saveSettingsBtn) {
        saveSettingsBtn.addEventListener('click', function() {
            console.log('Bouton "Mettre à jour mes infos" cliqué');
            saveGameSettings();
        });
    }

    const partnerSearchButton = document.getElementById('partnerSearchButton');
    if (partnerSearchButton) {
        partnerSearchButton.addEventListener('click', function() {
            console.log('Bouton "Rechercher un partenaire" cliqué');
            toggleSearch();
        });
    }

    console.log('? événements des boutons attachés');

    // Rétablit l'état de la sidebar (Amis) au chargement
    const friendsSidebar = document.getElementById('friendsSidebar');
    const friendsSidebarActive = localStorage.getItem('socialSidebarActive') === 'true';
    if (friendsSidebarActive && friendsSidebar) {
        friendsSidebar.classList.add('active');
        const toggleBtn = document.querySelector('.toggle-friends-btn');
        if (toggleBtn) toggleBtn.classList.add('active');
    }

    // Chargement des données sociales et rafraéchissement
    loadSocial();
    setInterval(loadSocial, 5000);

    // Vérifier si l'utilisateur est admin pour afficher le lien modération
    async function checkAdminStatus() {
        try {
            const response = await fetchProtected('/api/moderation/stats');
            if (response.ok) {
                // L'utilisateur est admin, afficher le lien
                const moderationLink = document.getElementById('moderationLink');
                if (moderationLink) {
                    moderationLink.style.display = 'flex';
                }
            }
        } catch (error) {
            // Pas admin ou erreur, ne rien afficher
            console.log('Utilisateur non-administrateur');
        }
    }
    checkAdminStatus();

    // Fonction de déconnexion
    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('username');
        localStorage.removeItem('mm_friends_data');
        window.location.href = '/';
    }

    // Attacher les event listeners pour les boutons de déconnexion
    document.querySelectorAll('.logout-link, .logout-link-header').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            logout();
        });
    });

    // Démarrer le heartbeat pour maintenir l'utilisateur en ligne
    (function startHeartbeat() {
        async function sendHeartbeat() {
            try {
                const response = await fetchProtected('/api/heartbeat.php', {
                    method: 'POST'
                });
                if (!response.ok) {
                    console.warn('Heartbeat failed:', response.status);
                }
            } catch (error) {
                console.error('Erreur heartbeat:', error);
            }
        }
        // Envoyer immédiatement
        sendHeartbeat();
        // Puis toutes les 5 minutes (300000ms)
        setInterval(sendHeartbeat, 300000);
    })();

    // Confirmation du chargement des fonctions
    console.log('? Initialisation terminée');
    console.log('Fonctions disponibles:');
    console.log('  - saveGameSettings:', typeof window.saveGameSettings);
    console.log('  - toggleSearch:', typeof window.toggleSearch);
    console.log('  - selectRank:', typeof window.selectRank);
    console.log('  - togglePrefRank:', typeof window.togglePrefRank);
})();
        // Synchronisation du chat avec le ChatManager (mémes callbacks que sur le dashboard)
        if (window.ChatManager && window.ChatManager.subscribe) {
            window.ChatManager.subscribe(() => {
                Object.keys(activeChats).forEach(usernameKey => {
                    if (usernameKey.endsWith('_callback')) return;
                    updateChatUI(usernameKey);
                });

                // Mettre à jour les badges de notification
                updateFriendsNotificationBadge();

                // Rafraîchir la liste des amis pour mettre à jour les badges individuels
                const friendsList = document.getElementById('friendsList');
                if (friendsList && friendsList.children.length > 0) {
                    loadSocial();
                }
            });
        }

    </script>

    <!-- Systéme de signalement d'utilisateur -->
    <script src="/report-user.js?v=1768165762094"></script>
</body>
</html>

