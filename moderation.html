<!DOCTYPE html>
<html lang="fr">
<head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-F7J6VTB5BZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-F7J6VTB5BZ');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modération - SafeMates</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0b1020;
            --card: #131a2b;
            --card-2: #101624;
            --text: #eef2ff;
            --muted: #9ca3af;
            --accent: #22c55e;
            --accent-2: #f59e0b;
            --danger: #ef4444;
            --border: #1f2937;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at 20% 20%, rgba(34,197,94,0.08), transparent 25%),
                        radial-gradient(circle at 80% 10%, rgba(245,158,11,0.08), transparent 25%),
                        linear-gradient(135deg, #0b1020 0%, #0f172a 60%, #0b1020 100%);
            color: var(--text);
        }
        .wrap {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px 20px 80px;
        }
        header {
            background: linear-gradient(135deg, rgba(34,197,94,0.18), rgba(59,130,246,0.12));
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 20px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.25);
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .btn-logout { background: #ef4444; color: #fff; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; border: none; }
        .btn-logout:hover { background: #dc2626; }
        h1 { margin: 0 0 6px 0; font-size: 24px; }
        p.lead { margin: 0; color: var(--muted); }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 14px; margin: 22px 0; }
        .stat { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 14px; }
        .stat-title { color: var(--muted); font-size: 13px; text-transform: uppercase; letter-spacing: 0.04em; }
        .stat-value { font-size: 28px; font-weight: 700; margin-top: 6px; }
        .stat.pending { border-color: rgba(245,158,11,0.4); }
        .stat.active { border-color: rgba(34,197,94,0.4); }
        .stat.banned { border-color: rgba(239,68,68,0.4); }
        .tabs { display: inline-flex; border: 1px solid var(--border); border-radius: 10px; overflow: hidden; background: var(--card-2); }
        .tab { padding: 10px 18px; cursor: pointer; color: var(--muted); border-right: 1px solid var(--border); user-select: none; }
        .tab:last-child { border-right: none; }
        .tab.active { background: var(--accent); color: #04100a; font-weight: 700; }
        .reports { margin-top: 20px; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 14px; box-shadow: 0 10px 40px rgba(0,0,0,0.25); }
        .card-header { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .badge { padding: 6px 10px; border-radius: 999px; font-size: 12px; font-weight: 700; text-transform: uppercase; }
        .badge.harassment { background: rgba(239,68,68,0.12); color: #f87171; }
        .badge.hate_speech { background: rgba(239,68,68,0.12); color: #fb7185; }
        .badge.inappropriate_content { background: rgba(245,158,11,0.12); color: #fbbf24; }
        .badge.spam { background: rgba(34,197,94,0.12); color: #34d399; }
        .badge.cheating { background: rgba(59,130,246,0.12); color: #93c5fd; }
        .badge.charter_violation { background: rgba(168,85,247,0.12); color: #d8b4fe; }
        .badge.other { background: rgba(148,163,184,0.12); color: #cbd5e1; }
        .meta { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin: 12px 0; font-size: 14px; color: var(--muted); }
        .desc { background: var(--card-2); border: 1px dashed var(--border); border-radius: 10px; padding: 12px; color: #cbd5e1; white-space: pre-wrap; }
        .actions { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px; }
        button { border: none; border-radius: 8px; cursor: pointer; font-weight: 700; }
        .btn { padding: 10px 14px; color: #0b1020; }
        .btn-warning { background: #f59e0b; color: #0f172a; }
        .btn-suspend { background: #f97316; color: #0f172a; }
        .btn-ban { background: #ef4444; color: #0f172a; }
        .btn-view { background: #38bdf8; color: #031018; }
        .btn-dismiss { background: #1f2937; color: #e5e7eb; border: 1px solid var(--border); }
        .empty { text-align: center; padding: 40px; color: var(--muted); border: 1px dashed var(--border); border-radius: 12px; background: var(--card-2); }
        .modal-backdrop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.55); align-items: center; justify-content: center; z-index: 9999; }
        .modal { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 18px; width: min(520px, 92vw); box-shadow: 0 20px 80px rgba(0,0,0,0.4); }
        .modal h3 { margin-top: 0; }
        .form-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 6px; color: var(--muted); font-weight: 600; font-size: 13px; }
        input, select, textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: #0f172a; color: var(--text); font-family: inherit; }
        textarea { min-height: 90px; resize: vertical; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }
        .btn-ghost { background: transparent; color: var(--muted); border: 1px solid var(--border); padding: 10px 14px; }
    </style>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-5W9WJ9ZKEK"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-5W9WJ9ZKEK');
    </script>
</head>
<body>
    <div class="wrap">
        <header>
            <div class="header-top">
                <div>
                    <h1>Espace Modération</h1>
                    <p class="lead">Consultez les signalements, appliquez des sanctions et suivez les statistiques.</p>
                </div>
                <button class="btn-logout" id="logoutBtn">Déconnexion</button>
            </div>
            <div class="stats">
                <div class="stat pending">
                    <div class="stat-title">Signalements en attente</div>
                    <div class="stat-value" id="pendingCount">-</div>
                </div>
                <div class="stat active">
                    <div class="stat-title">Sanctions actives</div>
                    <div class="stat-value" id="sanctionsCount">-</div>
                </div>
                <div class="stat banned">
                    <div class="stat-title">Utilisateurs bannis</div>
                    <div class="stat-value" id="bannedCount">-</div>
                </div>
            </div>
            <div class="tabs" id="tabs">
                <div class="tab active" data-tab="pending">En attente</div>
                <div class="tab" data-tab="resolved">Traités</div>
                <div class="tab" data-tab="banned">Bannis</div>
            </div>
        </header>

        <section class="reports" id="reportsSection">
            <div id="reportsContent"></div>
        </section>
    </div>

    <div class="modal-backdrop" id="sanctionModal">
        <div class="modal">
            <h3>Appliquer une sanction</h3>
            <form id="sanctionForm">
                <input type="hidden" id="sanctionUsername">
                <input type="hidden" id="sanctionReportId">

                <div class="form-group">
                    <label>Type</label>
                    <select id="sanctionType" required>
                        <option value="warning">Avertissement</option>
                        <option value="suspension">Suspension temporaire</option>
                        <option value="ban">Bannissement</option>
                    </select>
                </div>

                <div class="form-group" id="durationGroup">
                    <label>Durée (heures) - laisser vide pour permanent</label>
                    <input type="number" id="sanctionDuration" min="1" max="720">
                </div>

                <div class="form-group">
                    <label>Raison interne</label>
                    <textarea id="sanctionReason" required></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-ghost" onclick="closeSanctionModal()">Annuler</button>
                    <button type="submit" class="btn btn-warning">Appliquer</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentTab = 'pending';
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
        }

        function authFetch(url, options = {}) {
            const headers = {
                'Authorization': `Bearer ${token}`,
                ...(options.body ? { 'Content-Type': 'application/json' } : {}),
                ...(options.headers || {})
            };
            return fetch(url, { ...options, headers }).then((res) => {
                if (res.status === 401) {
                    localStorage.removeItem('token');
                    localStorage.removeItem('username');
                    window.location.href = '/login';
                    throw new Error('Session expirée');
                }
                return res;
            });
        }

        async function loadStats() {
            try {
                const res = await authFetch('/api/moderation/stats');
                if (!res.ok) throw new Error('Erreur stats');
                const stats = await res.json();
                document.getElementById('pendingCount').textContent = stats.pending_reports;
                document.getElementById('sanctionsCount').textContent = stats.active_sanctions;
                document.getElementById('bannedCount').textContent = stats.banned_users;
            } catch (e) {
                console.error('Erreur chargement stats', e);
            }
        }

        async function loadReports(status = 'pending') {
            if (status === 'banned') {
                loadBannedUsers();
                return;
            }
            try {
                const res = await authFetch(`/api/reports?status=${status}`);
                if (res.status === 403) {
                    alert('Accès refusé. Réservé aux modérateurs.');
                    window.location.href = '/dashboard';
                    return;
                }
                if (!res.ok) throw new Error('Erreur reports');
                const reports = await res.json();
                renderReports(reports);
            } catch (e) {
                console.error('Erreur chargement reports', e);
                document.getElementById('reportsContent').innerHTML = `<div class="empty">Impossible de charger les signalements.</div>`;
            }
        }

        async function loadBannedUsers() {
            try {
                const res = await authFetch('/api/moderation/banned-users');
                if (!res.ok) throw new Error('Erreur chargement utilisateurs bannis');
                const users = await res.json();
                renderBannedUsers(users);
            } catch (e) {
                console.error('Erreur chargement utilisateurs bannis', e);
                document.getElementById('reportsContent').innerHTML = `<div class="empty">Impossible de charger les utilisateurs bannis.</div>`;
            }
        }

        function renderReports(reports) {
            const container = document.getElementById('reportsContent');
            if (!reports.length) {
                container.innerHTML = `<div class="empty">Aucun signalement ${currentTab === 'pending' ? 'en attente' : 'traité'}.</div>`;
                return;
            }

            container.innerHTML = reports.map((r) => `
                <div class="card">
                    <div class="card-header">
                        <div class="badge ${r.reason}">${formatReason(r.reason)}</div>
                        <div style="color: var(--muted); font-size: 12px;">${formatDate(r.created_at)}</div>
                    </div>
                    <div class="meta">
                        <div><strong>Signalé par :</strong> ${r.reporter_username}</div>
                        <div><strong>Utilisateur Signalé :</strong> ${r.reported_username}</div>
                    </div>
                    ${r.description ? `<div class="desc">${r.description}</div>` : ''}
                    ${currentTab === 'pending' ? `
                        <div class="actions">
                            <button class="btn btn-warning" data-action="warning" data-username="${r.reported_username}" data-report-id="${r.id}">Avertir</button>
                            <button class="btn btn-suspend" data-action="suspension" data-username="${r.reported_username}" data-report-id="${r.id}">Suspendre</button>
                            <button class="btn btn-ban" data-action="ban" data-username="${r.reported_username}" data-report-id="${r.id}">Bannir</button>
                            <button class="btn btn-view" data-action="history" data-username="${r.reported_username}">Historique</button>
                            <button class="btn btn-dismiss" data-action="dismiss" data-report-id="${r.id}">Classer</button>
                        </div>
                    ` : `
                        <div style="color: var(--muted); font-size: 13px; margin-top: 10px;">
                            traité par ${r.resolver_username || 'Admin'} le ${formatDate(r.resolved_at)}
                            ${r.resolution_note ? `<br>Note : ${r.resolution_note}` : ''}
                        </div>
                    `}
                </div>
            `).join('');
        }

        function openSanctionModal(username, type, reportId) {
            document.getElementById('sanctionUsername').value = username;
            document.getElementById('sanctionReportId').value = reportId;
            document.getElementById('sanctionType').value = type;
            document.getElementById('sanctionDuration').value = '';
            document.getElementById('sanctionReason').value = '';
            document.getElementById('durationGroup').style.display = type === 'ban' ? 'none' : 'block';
            document.getElementById('sanctionModal').style.display = 'flex';
        }

        function closeSanctionModal() {
            document.getElementById('sanctionModal').style.display = 'none';
        }

        document.getElementById('sanctionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('sanctionUsername').value;
            const reportId = document.getElementById('sanctionReportId').value;
            const type = document.getElementById('sanctionType').value;
            const reason = document.getElementById('sanctionReason').value;
            const durationHours = document.getElementById('sanctionDuration').value || null;

            try {
                const res = await authFetch('/api/sanctions', {
                    method: 'POST',
                    body: JSON.stringify({ username, type, reason, durationHours })
                });
                if (!res.ok) throw new Error('sanction');

                await authFetch(`/api/reports/${reportId}/resolve`, {
                    method: 'POST',
                    body: JSON.stringify({ action: type, note: reason })
                });

                alert('Sanction appliquée');
                closeSanctionModal();
                loadStats();
                loadReports(currentTab);
            } catch (err) {
                console.error('Erreur sanction', err);
                alert('Erreur lors de l\'application de la sanction');
            }
        });

        async function dismissReport(reportId) {
            if (!confirm('Classer ce signalement sans suite ?')) return;
            try {
                const res = await authFetch(`/api/reports/${reportId}/resolve`, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'dismissed', note: 'classe sans suite' })
                });
                if (!res.ok) throw new Error('dismiss');
                alert('Signalement classé');
                loadStats();
                loadReports(currentTab);
            } catch (err) {
                console.error('Erreur dismiss', err);
                alert('Erreur lors du classement');
            }
        }

        async function viewHistory(username) {
            try {
                const res = await authFetch(`/api/sanctions/${username}`);
                if (!res.ok) throw new Error('history');
                const items = await res.json();
                if (!items.length) {
                    alert(`${username} n'a aucune sanction.`);
                    return;
                }
                const text = items.map((s) => `${formatDate(s.issued_at)} - ${s.type.toUpperCase()} par ${s.admin_username || 'Admin'}\nRaison: ${s.reason}${s.expires_at ? `\nExpire: ${formatDate(s.expires_at)}` : ''}`).join('\n\n');
                alert(`Historique des sanctions de ${username}:\n\n${text}`);
            } catch (err) {
                console.error('Erreur historique', err);
                alert('Impossible de charger l\'historique');
            }
        }

        function renderBannedUsers(users) {
            const container = document.getElementById('reportsContent');
            if (!users.length) {
                container.innerHTML = `<div class="empty">Aucun utilisateur banni.</div>`;
                return;
            }

            container.innerHTML = users.map((u) => `
                <div class="card">
                    <div class="card-header">
                        <div style="font-weight: 700; font-size: 16px; color: var(--text);">${u.username}</div>
                        <div style="color: var(--muted); font-size: 12px;">${u.email}</div>
                    </div>
                    <div class="meta">
                        <div><strong>ID:</strong> ${u.id}</div>
                        <div><strong>Banni depuis:</strong> ${formatDate(u.banned_at)}</div>
                    </div>
                    ${u.last_sanction_reason ? `<div class="desc">Dernière raison: ${u.last_sanction_reason}</div>` : ''}
                    <div class="actions">
                        <button class="btn btn-warning" data-action="unban" data-user-id="${u.id}" data-username="${u.username}">Débannir</button>
                        <button class="btn btn-view" data-action="history" data-username="${u.username}">Historique</button>
                    </div>
                </div>
            `).join('');
        }

        async function unbanUser(userId, username) {
            if (!confirm(`Êtes-vous sûr de vouloir Débannir ${username} ?`)) return;
            try {
                const res = await authFetch(`/api/moderation/unban/${userId}`, {
                    method: 'POST'
                });
                if (!res.ok) throw new Error('Erreur débannissement');
                alert(`${username} a été débanni avec succès.`);
                loadStats();
                loadBannedUsers();
            } catch (err) {
                console.error('Erreur débannissement', err);
                alert('Erreur lors du débannissement');
            }
        }

        function switchTab(tab, el) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            if (el) el.classList.add('active');
            loadReports(tab);
        }

        function formatReason(reason) {
            const reasons = {
                harassment: 'Harcelement',
                hate_speech: 'Discours haineux',
                inappropriate_content: 'Contenu inapproprie',
                spam: 'Spam',
                cheating: 'Triche',
                charter_violation: 'Violation de la charte',
                other: 'Autre'
            };
            return reasons[reason] || reason;
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('fr-FR', { hour12: false });
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            window.location.href = '/';
        }

        // Event listener pour le bouton de Déconnexion
        document.getElementById('logoutBtn').addEventListener('click', logout);

        window.addEventListener('click', (e) => {
            const backdrop = document.getElementById('sanctionModal');
            if (e.target === backdrop) closeSanctionModal();
        });

        // Gestion des clics sur les onglets (sans inline)
        document.getElementById('tabs').addEventListener('click', (e) => {
            const tabEl = e.target.closest('.tab');
            if (!tabEl) return;
            switchTab(tabEl.dataset.tab, tabEl);
        });

        // Délégation des actions sur les boutons de report
        document.getElementById('reportsSection').addEventListener('click', (e) => {
            const btn = e.target.closest('[data-action]');
            if (!btn) return;
            const action = btn.dataset.action;
            const username = btn.dataset.username;
            const reportId = btn.dataset.reportId;
            const userId = btn.dataset.userId;

            if (action === 'warning' || action === 'suspension' || action === 'ban') {
                openSanctionModal(username, action, reportId);
            } else if (action === 'history') {
                viewHistory(username);
            } else if (action === 'dismiss') {
                dismissReport(reportId);
            } else if (action === 'unban') {
                unbanUser(userId, username);
            }
        });

        loadStats();
        loadReports('pending');
    </script>
</body>
</html>
