<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Test Debug - Game</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #1a1a1a;
      color: #fff;
    }
    .test-section {
      background: #2a2a2a;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      font-size: 16px;
      cursor: pointer;
      background: #22c55e;
      color: white;
      border: none;
      border-radius: 5px;
    }
    button:hover {
      background: #16a34a;
    }
    .rank-option {
      display: inline-block;
      margin: 10px;
      padding: 10px;
      border: 2px solid #444;
      border-radius: 8px;
      cursor: pointer;
    }
    .rank-option.active {
      border-color: #22c55e;
      background: rgba(34, 197, 94, 0.2);
    }
    .rank-option img {
      width: 60px;
      height: 60px;
      display: block;
    }
    #console {
      background: #000;
      padding: 10px;
      margin-top: 20px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }
    .log-entry {
      margin: 5px 0;
    }
    .log-success { color: #22c55e; }
    .log-error { color: #ef4444; }
    .log-info { color: #3b82f6; }
  </style>
</head>
<body>
  <h1>üîß Test de Debug - Page Game</h1>

  <div class="test-section">
    <h2>1. Test Token JWT</h2>
    <p id="tokenStatus">V√©rification...</p>
    <button onclick="testToken()">Tester Token</button>
  </div>

  <div class="test-section">
    <h2>2. Test S√©lection de Rang</h2>
    <div id="rankTest">
      <div class="rank-option" data-rank-id="fer1" onclick="testSelectRank('fer1')">
        <img src="/Valorant_rank/Iron_1_Rank.webp" alt="Fer 1">
        <span>Fer 1</span>
      </div>
      <div class="rank-option" data-rank-id="bronze1" onclick="testSelectRank('bronze1')">
        <img src="/Valorant_rank/Bronze_1_Rank.webp" alt="Bronze 1">
        <span>Bronze 1</span>
      </div>
      <div class="rank-option" data-rank-id="argent1" onclick="testSelectRank('argent1')">
        <img src="/Valorant_rank/Silver_1_Rank.webp" alt="Argent 1">
        <span>Argent 1</span>
      </div>
    </div>
    <p>Rang s√©lectionn√©: <span id="selectedRank">Aucun</span></p>
  </div>

  <div class="test-section">
    <h2>3. Test Sauvegarde</h2>
    <button onclick="testSaveSettings()">Tester Sauvegarde</button>
    <p id="saveResult"></p>
  </div>

  <div class="test-section">
    <h2>4. Test Recherche Partenaire</h2>
    <button onclick="testSearch()">Tester Recherche</button>
    <p id="searchResult"></p>
  </div>

  <div class="test-section">
    <h2>üìã Console de Debug</h2>
    <button onclick="clearConsole()">Effacer Console</button>
    <div id="console"></div>
  </div>

  <script>
    // Variables globales
    let selectedRank = null;
    const gameId = 'valorant';

    // Fonction de log
    function log(message, type = 'info') {
      const consoleEl = document.getElementById('console');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      const timestamp = new Date().toLocaleTimeString();
      entry.textContent = `[${timestamp}] ${message}`;
      consoleEl.appendChild(entry);
      consoleEl.scrollTop = consoleEl.scrollHeight;
      console.log(message);
    }

    function clearConsole() {
      document.getElementById('console').innerHTML = '';
    }

    // Test 1: V√©rifier le token
    function testToken() {
      const token = localStorage.getItem('token');
      const username = localStorage.getItem('username');
      const statusEl = document.getElementById('tokenStatus');

      if (token) {
        statusEl.innerHTML = `‚úÖ Token trouv√©<br>Username: ${username || 'Non trouv√©'}`;
        statusEl.style.color = '#22c55e';
        log(`Token JWT pr√©sent (${token.substring(0, 20)}...)`, 'success');
      } else {
        statusEl.innerHTML = '‚ùå Aucun token trouv√© - Vous devez vous connecter';
        statusEl.style.color = '#ef4444';
        log('Aucun token JWT trouv√©', 'error');
      }
    }

    // Test 2: S√©lection de rang
    function testSelectRank(rankId) {
      log(`Tentative de s√©lection du rang: ${rankId}`, 'info');
      selectedRank = rankId;

      // Mise √† jour visuelle
      document.querySelectorAll('.rank-option').forEach(el => {
        el.classList.remove('active');
      });
      document.querySelector(`[data-rank-id="${rankId}"]`).classList.add('active');

      document.getElementById('selectedRank').textContent = rankId;
      log(`Rang s√©lectionn√© avec succ√®s: ${rankId}`, 'success');
    }

    // Test 3: Sauvegarde
    async function testSaveSettings() {
      log('=== D√âBUT TEST SAUVEGARDE ===', 'info');
      const resultEl = document.getElementById('saveResult');

      const token = localStorage.getItem('token');
      if (!token) {
        resultEl.textContent = '‚ùå Pas de token - Connectez-vous d\'abord';
        log('√âchec: Pas de token JWT', 'error');
        return;
      }

      if (!selectedRank) {
        resultEl.textContent = '‚ùå S√©lectionnez un rang d\'abord';
        log('√âchec: Aucun rang s√©lectionn√©', 'error');
        return;
      }

      const payload = {
        gameId: gameId,
        rank: selectedRank,
        mainMode: 'Class√©',
        options: []
      };

      log(`Envoi des donn√©es: ${JSON.stringify(payload)}`, 'info');

      try {
        const response = await fetch('/api/game/settings', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(payload)
        });

        log(`R√©ponse HTTP: ${response.status} ${response.statusText}`, 'info');

        if (response.ok) {
          const data = await response.json();
          resultEl.textContent = '‚úÖ Sauvegarde r√©ussie!';
          resultEl.style.color = '#22c55e';
          log(`Succ√®s: ${JSON.stringify(data)}`, 'success');
        } else {
          const error = await response.text();
          resultEl.textContent = `‚ùå Erreur ${response.status}`;
          resultEl.style.color = '#ef4444';
          log(`Erreur ${response.status}: ${error}`, 'error');
        }
      } catch (err) {
        resultEl.textContent = `‚ùå Erreur: ${err.message}`;
        log(`Erreur r√©seau: ${err.message}`, 'error');
      }

      log('=== FIN TEST SAUVEGARDE ===', 'info');
    }

    // Test 4: Recherche
    async function testSearch() {
      log('=== D√âBUT TEST RECHERCHE ===', 'info');
      const resultEl = document.getElementById('searchResult');

      const token = localStorage.getItem('token');
      if (!token) {
        resultEl.textContent = '‚ùå Pas de token - Connectez-vous d\'abord';
        log('√âchec: Pas de token JWT', 'error');
        return;
      }

      try {
        const response = await fetch(`/api/match/search/${gameId}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        log(`R√©ponse HTTP: ${response.status} ${response.statusText}`, 'info');

        if (response.ok) {
          const matches = await response.json();
          resultEl.textContent = `‚úÖ ${matches.length} partenaire(s) trouv√©(s)`;
          resultEl.style.color = '#22c55e';
          log(`Succ√®s: ${matches.length} matchs trouv√©s`, 'success');
          log(`D√©tails: ${JSON.stringify(matches)}`, 'info');
        } else {
          const error = await response.text();
          resultEl.textContent = `‚ùå Erreur ${response.status}`;
          resultEl.style.color = '#ef4444';
          log(`Erreur ${response.status}: ${error}`, 'error');
        }
      } catch (err) {
        resultEl.textContent = `‚ùå Erreur: ${err.message}`;
        log(`Erreur r√©seau: ${err.message}`, 'error');
      }

      log('=== FIN TEST RECHERCHE ===', 'info');
    }

    // Initialisation
    window.onload = function() {
      log('Page de debug charg√©e', 'success');
      testToken();
    };
  </script>
</body>
</html>
