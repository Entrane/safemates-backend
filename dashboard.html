<!DOCTYPE html>
<html lang="fr">
<head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-F7J6VTB5BZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-F7J6VTB5BZ');
</script>
  <meta charset="UTF-8" />
  <title>Tableau de bord - SafeMates</title>
  <meta name="description" content="Votre tableau de bord SafeMates : accédez à votre bibliothèque de jeux, gérez vos amis et trouvez des coéquipières pour vos parties." />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#22c55e" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  <!-- Preconnect pour optimiser le chargement -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" />

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'" />
  <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" /></noscript>
  <!-- Nouveau style multicolore animé -->
  <link rel="stylesheet" href="style-multicolor-animated.css" />
  <link rel="stylesheet" href="ads.css?v=1768165762094" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
  <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" /></noscript>

  <!-- Google AdSense Script -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9926958602882647"
     crossorigin="anonymous"></script>

  <style>
    /* --- NOTIFICATIONS --- */
    .notification-bell {
        position: relative;
        background: none;
        border: none;
        color: var(--text-main);
        font-size: 1.2rem;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        transition: background 0.2s;
        margin-right: 15px;
    }

    .notification-bell:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .notification-badge {
        position: absolute;
        top: 0;
        right: 0;
        background: #ef4444;
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 0.7rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }

    .notifications-panel {
        position: fixed;
        top: 75px;
        right: 20px;
        width: 380px;
        max-height: 550px;
        background: var(--bg-card);
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
        z-index: 1001;
        display: none;
        flex-direction: column;
        border: 2px solid rgba(34, 197, 94, 0.1);
        backdrop-filter: blur(20px) saturate(180%);
        animation: slideInDown 0.3s ease-out;
    }

    @keyframes slideInDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .notifications-panel.active {
        display: flex;
    }

    .notifications-header {
        padding: 15px;
        border-bottom: 1px solid #334155;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .notifications-header h3 {
        margin: 0;
        font-size: 1.1rem;
        color: var(--text-main);
    }

    .clear-all-btn {
        background: none;
        border: none;
        color: var(--primary-color);
        cursor: pointer;
        font-size: 0.8rem;
    }

    .notifications-list {
        flex-grow: 1;
        overflow-y: auto;
        max-height: 400px;
    }

    .notification-item {
        padding: 14px 16px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: flex-start;
        gap: 12px;
        position: relative;
    }

    .notification-item:hover {
        background: var(--bg-card-hover);
        transform: translateX(4px);
    }

    .notification-item.unread {
        background: var(--primary-light);
        border-left: 4px solid var(--primary-color);
    }

    .notification-item.unread::after {
        content: '';
        position: absolute;
        right: 14px;
        top: 50%;
        transform: translateY(-50%);
        width: 8px;
        height: 8px;
        background: var(--primary-color);
        border-radius: 50%;
        box-shadow: 0 0 0 3px var(--primary-light);
    }

    .notification-icon {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        flex-shrink: 0;
        margin-top: 2px;
    }

    .notification-icon.friend_request {
        background: #3b82f6;
        color: white;
    }

    .notification-icon.new_message {
        background: var(--primary-color);
        color: white;
    }

    .notification-icon.match_found {
        background: #f59e0b;
        color: white;
    }

    .notification-content {
        flex-grow: 1;
    }

    .notification-title {
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--text-main);
        margin-bottom: 2px;
    }

    .notification-message {
        font-size: 0.8rem;
        color: var(--text-muted);
        line-height: 1.3;
    }

    .notification-time {
        font-size: 0.7rem;
        color: var(--text-muted);
        margin-top: 4px;
    }

    .notifications-empty {
        padding: 30px 20px;
        text-align: center;
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    /* Styles CSS basés sur les versions précédentes */
    :root {
      --primary-color: #22c55e;
      --primary-hover: #16a34a;
      --primary-light: rgba(34, 197, 94, 0.1);
      --sidebar-width: 320px;
      --side-nav-width: 230px;
      --bg-dark: #0a0f1e;
      --bg-card: #1a2332;
      --bg-card-hover: #242d3f;
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --border-color: #334155;
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.2);
      --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.3);
      --shadow-glow: 0 0 20px rgba(34, 197, 94, 0.2);
    }

    body {
        background: linear-gradient(135deg, #0a0f1e 0%, #0f172a 50%, #0a0f1e 100%);
        background-attachment: fixed;
        color: var(--text-main);
        font-family: 'Inter', sans-serif;
        margin: 0;
        overflow-x: hidden;
        padding-left: var(--side-nav-width);
    }

    /* --- LAYOUT PRINCIPAL --- */
    .dashboard-layout {
      max-width: 1100px;
      margin: 40px auto;
      padding: 0 20px;
      margin-left: calc(var(--side-nav-width) - 20px);
    }
    
    header {
        display: none;
    }
    
    .logo {
        color: var(--primary-color);
        font-size: 1.5rem;
        font-weight: 800;
        text-decoration: none;
        text-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
        transition: all 0.3s ease;
    }

    .logo:hover {
        text-shadow: 0 0 30px rgba(34, 197, 94, 0.5);
        transform: scale(1.05);
    }

    .nav-links a {
        color: var(--text-main);
        text-decoration: none;
        margin-left: 25px;
        padding: 8px 16px;
        border-radius: 8px;
        transition: all 0.3s ease;
        position: relative;
    }

    .nav-links a:hover {
        color: var(--primary-color);
        background: var(--primary-light);
    }
    
    .profile-section { 
        display: flex; 
        align-items: center; 
    }
    
    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
        color: var(--bg-dark);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
    }

    .user-avatar:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(34, 197, 94, 0.5);
    }

    /* --- SIDE NAV --- */
    .side-nav {
        position: fixed;
        top: 0;
        left: 0;
        width: var(--side-nav-width);
        height: 100vh;
        background: linear-gradient(180deg, rgba(15,23,42,0.95) 0%, rgba(10,15,30,0.95) 100%);
        border-right: 1px solid rgba(255,255,255,0.05);
        box-shadow: 8px 0 30px rgba(0,0,0,0.35);
        padding: 20px 16px;
        box-sizing: border-box;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 14px;
    }

    .side-nav .nav-title {
        font-weight: 800;
        letter-spacing: -0.02em;
        font-size: 1.1rem;
        color: var(--primary-color);
        margin-bottom: 10px;
    }

    .side-nav a.nav-link {
        color: var(--text-main);
        text-decoration: none;
        padding: 10px 8px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        gap: 10px;
        background: transparent;
        border: none;
        transition: color 0.2s, transform 0.15s;
    }

    .side-nav a.nav-link:hover {
        color: var(--primary-color);
        transform: translateX(2px);
    }

    .side-nav .nav-toggle {
        background: transparent;
        color: var(--text-main);
        border: none;
        border-radius: 6px;
        padding: 10px 8px;
        width: 100%;
        text-align: left;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        font-weight: 600;
    }

    .side-nav .nav-toggle .chevron {
        transition: transform 0.2s ease;
    }

    .side-nav .nav-toggle.open .chevron {
        transform: rotate(90deg);
    }

    .side-nav .nav-sublist {
        display: none;
        flex-direction: column;
        gap: 6px;
        margin-left: 10px;
        padding-left: 6px;
        border-left: 1px solid rgba(255,255,255,0.08);
    }

    .side-nav .nav-sublist.open {
        display: flex;
    }

    .side-nav .nav-sublist a {
        color: var(--text-main);
        text-decoration: none;
        padding: 8px 6px;
        border-radius: 6px;
        background: transparent;
        border: none;
        transition: color 0.2s, transform 0.15s;
        font-size: 0.95rem;
    }

    .side-nav .nav-sublist a:hover {
        color: var(--primary-color);
        transform: translateX(2px);
    }

    
    /* --- SECTION JEUX --- */
    h2 {
        color: var(--text-main);
        margin-bottom: 25px;
        padding-bottom: 12px;
        font-size: 1.8rem;
        font-weight: 700;
        position: relative;
    }

    h2::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 60px;
        height: 3px;
        background: linear-gradient(90deg, var(--primary-color) 0%, transparent 100%);
        border-radius: 2px;
    }

    .search-bar {
        margin-bottom: 25px;
        display: flex;
        gap: 10px;
    }

    #searchInput {
        flex-grow: 1;
        padding: 14px 20px;
        border-radius: 12px;
        border: 2px solid rgba(255, 255, 255, 0.05);
        background: var(--bg-card);
        color: var(--text-main);
        font-size: 1rem;
        transition: all 0.3s ease;
        outline: none;
    }

    #searchInput:focus {
        border-color: var(--primary-color);
        background: var(--bg-card-hover);
        box-shadow: 0 0 0 4px var(--primary-light);
    }

    #searchInput::placeholder {
        color: var(--text-muted);
    }
    
    /* --- BIBLIOTHEQUE --- */
    .library-section {
        margin-bottom: 40px;
    }

    .library-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
    }

    .library-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .game-card {
        position: relative;
        background: var(--bg-card);
        border-radius: 16px;
        overflow: hidden;
        min-height: 260px;
        box-shadow: var(--shadow-md);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .game-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: var(--shadow-lg), var(--shadow-glow);
        border-color: rgba(34, 197, 94, 0.3);
    }

    .game-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(34, 197, 94, 0) 0%, rgba(34, 197, 94, 0.1) 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 1;
        pointer-events: none;
    }

    .game-card:hover::before {
        opacity: 1;
    }

    .game-img { 
        width: 100%; 
        height: 100%; 
        object-fit: cover; 
    }
    
    .game-overlay { 
        position: absolute; 
        bottom: 0; 
        left: 0; 
        right: 0; 
        background: linear-gradient(to top, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0)); 
        padding: 12px; 
    }
    
    .game-title { 
        color: white; 
        font-weight: 700; 
        font-size: 1.05rem; 
        letter-spacing: -0.01em;
    }
    
    
    /* --- Styles sociaux --- */
    /* --- BOUTON SIDEBAR --- */
    .toggle-friends-btn {
      position: fixed;
      top: 90px;
      right: 20px;
      z-index: 10000;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
      color: #fff;
      border: none;
      padding: 12px 20px;
      border-radius: 50px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 0.95rem;
      box-shadow: 0 8px 24px rgba(34, 197, 94, 0.4);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .toggle-friends-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(34, 197, 94, 0.5);
    }

    .toggle-friends-btn.active {
        right: calc(var(--sidebar-width) + 20px);
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
    }

    .toggle-friends-btn.active:hover {
        box-shadow: 0 12px 32px rgba(239, 68, 68, 0.5);
    }
    
    .toggle-friends-btn.active span {
        display: none;
    }

    .toggle-friends-btn.active::after {
        content: '✕';
        font-size: 1.2rem;
    }

    .social-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
    }

    .user-pill {
        padding: 8px 12px;
        border-radius: 8px;
        background: rgba(34, 197, 94, 0.1);
        color: var(--text-main);
        font-weight: 600;
        font-size: 0.9rem;
        border: 1px solid rgba(34, 197, 94, 0.3);
        white-space: nowrap;
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: right;
    }

    /* --- SIDEBAR SOCIALE (Amis) --- */
    .friends-sidebar {
      position: fixed;
      top: 0;
      right: calc(0px - var(--sidebar-width));
      width: var(--sidebar-width);
      height: 100vh;
      background: rgba(10, 15, 30, 0.98);
      border-left: 2px solid rgba(34, 197, 94, 0.1);
      box-shadow: -20px 0 60px rgba(0, 0, 0, 0.6);
      padding: 90px 20px 20px;
      z-index: 1000;
      transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      gap: 15px;
      backdrop-filter: blur(20px) saturate(180%);
      box-sizing: border-box;
      overflow-y: auto;
    }

    .friends-sidebar::-webkit-scrollbar {
      width: 6px;
    }

    .friends-sidebar::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }

    .friends-sidebar::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 10px;
    }

    .friends-sidebar::-webkit-scrollbar-thumb:hover {
      background: var(--primary-hover);
    }
    
    .friends-sidebar.active { 
        right: 0; 
    } 

    .sidebar-section-title { 
        font-size: 0.75rem; 
        text-transform: uppercase; 
        color: var(--text-muted); 
        margin-top: 15px; 
        font-weight: 700; 
    }
    
    .friend-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        border-radius: 12px;
        background: var(--bg-card);
        border: 1px solid rgba(255, 255, 255, 0.05);
        cursor: pointer;
        margin-bottom: 8px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .friend-card::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 3px;
        background: var(--primary-color);
        transform: scaleY(0);
        transition: transform 0.3s ease;
    }

    .friend-card:hover {
        background: var(--bg-card-hover);
        border-color: rgba(34, 197, 94, 0.3);
        transform: translateX(4px);
    }

    .friend-card:hover::before {
        transform: scaleY(1);
    }
    
    .friend-avatar { 
        width: 32px; 
        height: 32px; 
        border-radius: 50%; 
        background: #3b82f6; 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        font-weight: bold; 
        margin-right: 10px; 
        color: white;
    }
    
    .add-friend-box { 
        display: flex; 
        gap: 5px; 
    }
    
    .add-friend-box input { 
        flex: 1; 
        background: rgba(0,0,0,0.3); 
        border: 1px solid #334155; 
        border-radius: 20px; 
        padding: 6px 12px; 
        color: white; 
        outline: none; 
    }
    
    .add-friend-box button { 
        background: var(--primary-color); 
        border: none; 
        width: 32px; 
        height: 32px; 
        border-radius: 50%; 
        cursor: pointer; 
        font-weight: bold; 
        color: var(--bg-dark);
    }

    /* CHAT CONTAINER & WINDOW */
    .chat-container { 
        position: fixed; 
        bottom: 0; 
        right: calc(20px); 
        display: flex; 
        flex-direction: row-reverse; 
        gap: 15px; 
        z-index: 900; 
        transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        pointer-events: none; 
    }
    
    .friends-sidebar.active ~ .chat-container { 
        right: calc(var(--sidebar-width) + 20px); 
    }
    
    .chat-window {
        width: 300px; 
        height: 400px; 
        background: var(--bg-card); 
        border-radius: 12px 12px 0 0; 
        display: flex; 
        flex-direction: column;
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.4);
        pointer-events: auto; 
    }
    
    .chat-header {
        padding: 10px 15px; 
        background: var(--primary-color); 
        color: var(--bg-dark); 
        font-weight: 600; 
        cursor: pointer; 
        display: flex;
        justify-content: space-between; 
        align-items: center; 
        border-radius: 10px 10px 0 0;
    }
    
    .chat-body {
        flex-grow: 1; 
        overflow-y: auto; 
        padding: 15px; 
        display: flex; 
        flex-direction: column; 
        gap: 8px; 
        background: #141c2c;
    }
    
    .chat-input-area { 
        display: flex; 
        padding: 10px; 
        border-top: 1px solid #334155; 
    }
    
    .chat-input-area input {
        flex-grow: 1; 
        padding: 10px; 
        border: 1px solid #334155; 
        border-radius: 8px; 
        background: var(--bg-dark); 
        color: var(--text-main); 
        margin-right: 10px;
        outline: none;
    }
    
    .chat-input-area button {
        background: var(--primary-color);
        color: var(--bg-dark);
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1rem;
    }

    /* Style pour le bouton de suppression d'ami */
    .remove-friend-btn:hover {
        background: #ef4444 !important;
        color: white !important;
        transform: scale(1.1);
    }

    /* Badge de notification sur le bouton Amis */
    .friends-notification-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        border-radius: 50%;
        min-width: 22px;
        height: 22px;
        padding: 0 6px;
        font-size: 0.75rem;
        display: none;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        border: 3px solid var(--bg-dark);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.6), 0 0 0 1px rgba(239, 68, 68, 0.3);
        animation: pulse-glow 2s ease-in-out infinite;
        z-index: 10;
    }

    .friends-notification-badge.active {
        display: flex;
    }

    @keyframes pulse-glow {
        0%, 100% {
            transform: scale(1);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.6), 0 0 0 1px rgba(239, 68, 68, 0.3);
        }
        50% {
            transform: scale(1.15);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.8), 0 0 0 2px rgba(239, 68, 68, 0.5), 0 0 20px rgba(239, 68, 68, 0.4);
        }
    }

    /* Badge sur une carte d'ami avec message non lu */
    .friend-card-badge {
        background: var(--primary-color);
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 0.7rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-left: auto;
        margin-right: 8px;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% {
            transform: scale(1);
            opacity: 1;
        }
        50% {
            transform: scale(1.1);
            opacity: 0.8;
        }
    }

    /* Boutons Accepter/Refuser les demandes d'amis - Améliorés */
    .action-btn {
        min-width: 36px;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 0.9rem;
        border: none;
        font-weight: 600;
        position: relative;
        overflow: hidden;
    }

    .action-btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
    }

    .action-btn:active::before {
        width: 100px;
        height: 100px;
    }

    /* Bouton Accepter (Vert) */
    .action-btn.accept {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
    }

    .action-btn.accept:hover {
        background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
        box-shadow: 0 6px 20px rgba(34, 197, 94, 0.5);
        transform: translateY(-2px) scale(1.05);
    }

    .action-btn.accept:active {
        transform: translateY(0) scale(0.98);
    }

    /* Bouton Refuser (Rouge) */
    .action-btn.reject {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .action-btn.reject:hover {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
        transform: translateY(-2px) scale(1.05);
    }

    .action-btn.reject:active {
        transform: translateY(0) scale(0.98);
    }

    /* Menu trois points pour les amis */
    .friend-menu-container {
        position: relative;
    }

    .friend-menu-btn {
        min-width: 32px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        border-radius: 8px;
        transition: all 0.2s;
    }

    .friend-menu-btn:hover {
        background: rgba(156, 163, 175, 0.1);
        color: #fff;
    }

    .friend-menu-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        background: var(--bg-dark);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        min-width: 180px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        display: none;
        flex-direction: column;
        z-index: 1000;
        margin-top: 4px;
        overflow: hidden;
    }

    .friend-menu-dropdown.show {
        display: flex;
    }

    .friend-menu-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: transparent;
        border: none;
        color: #fff;
        cursor: pointer;
        transition: all 0.2s;
        text-align: left;
        font-size: 0.9rem;
    }

    .friend-menu-item:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    .friend-menu-item.report-friend-btn {
        color: #ffa726;
    }

    .friend-menu-item.report-friend-btn:hover {
        background: rgba(255, 167, 38, 0.1);
    }

    .friend-menu-item.remove-friend-btn {
        color: #ef4444;
    }

    .friend-menu-item.remove-friend-btn:hover {
        background: rgba(239, 68, 68, 0.1);
    }

    .friend-menu-item i {
        width: 16px;
    }

    /* STYLES DES BULLES DE CHAT */
    .msg {
        max-width: 70%;
        padding: 10px 14px;
        border-radius: 18px;
        font-size: 0.9rem;
        word-wrap: break-word;
        margin: 4px 0;
        position: relative;
        animation: messageSlideIn 0.3s ease-out;
    }

    .msg.self {
        background: var(--primary-color);
        color: white;
        align-self: flex-end;
        margin-left: auto;
        margin-right: 8px;
        border-bottom-right-radius: 4px;
    }

    .msg.other {
        background: #9ca3af;
        color: #1f2937;
        align-self: flex-start;
        margin-right: auto;
        margin-left: 8px;
        border-bottom-left-radius: 4px;
    }

    /* Animation d'apparition des messages */
    @keyframes messageSlideIn {
        from {
            opacity: 0;
            transform: translateY(10px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    /* Queue de bulle pour les messages envoyés (vert) */
    .msg.self::before {
        content: '';
        position: absolute;
        bottom: 0;
        right: -8px;
        width: 0;
        height: 0;
        border-left: 8px solid var(--primary-color);
        border-top: 8px solid transparent;
        border-bottom: 8px solid transparent;
    }

    /* Queue de bulle pour les messages reçus (gris) */
    .msg.other::before {
        content: '';
        position: absolute;
        bottom: 0;
        left: -8px;
        width: 0;
        height: 0;
        border-right: 8px solid #9ca3af;
        border-top: 8px solid transparent;
        border-bottom: 8px solid transparent;
    }

    /* --- BOUTON HAMBURGER MOBILE --- */
    .mobile-menu-toggle {
      display: none;
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1001;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 12px;
      color: var(--bg-dark);
      font-size: 1.3rem;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
      transition: all 0.3s ease;
    }

    .mobile-menu-toggle:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(34, 197, 94, 0.5);
    }

    .mobile-menu-toggle:active {
      transform: scale(0.95);
    }

    /* --- RESPONSIVE MOBILE --- */
    @media (max-width: 768px) {
      /* Afficher le bouton hamburger sur mobile */
      .mobile-menu-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* Navigation latérale rétractable sur mobile */
      .side-nav {
        left: calc(0px - var(--side-nav-width));
        transition: left 0.3s ease;
      }

      .side-nav.mobile-active {
        left: 0;
      }

      /* Overlay pour fermer le menu */
      .mobile-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }

      .mobile-overlay.active {
        display: block;
      }

      /* Supprimer le padding left du body */
      body {
        padding-left: 0;
      }

      /* Réajuster la mise en page du dashboard */
      .dashboard-layout {
        margin-left: 0;
        padding: 0 15px;
      }

      /* Ajuster la grille des jeux pour mobile */
      .game-grid {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 15px;
      }

      /* Améliorer la lisibilité des cartes de jeu */
      .game-card {
        padding: 12px;
      }

      /* Ajuster la barre de recherche */
      #searchInput {
        padding: 12px 16px;
        font-size: 0.95rem;
      }

      /* Ajuster les titres */
      h2 {
        font-size: 1.5rem;
        margin-bottom: 20px;
      }
    }

    @media (max-width: 480px) {
      /* Pour les très petits écrans */
      .game-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 12px;
      }

      .dashboard-layout {
        padding: 0 10px;
        margin: 20px auto;
      }

      h2 {
        font-size: 1.3rem;
      }
    }

  </style>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-5W9WJ9ZKEK"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-5W9WJ9ZKEK');
  </script>
</head>
<body class="dashboard-page">
  <!-- Arrière-plan animé -->
  <div class="animated-background"></div>
  <div class="grain-overlay"></div>

  <!-- Bouton hamburger mobile -->
  <button class="mobile-menu-toggle" id="mobileMenuToggle">
    <i class="fas fa-bars"></i>
  </button>

  <!-- Overlay mobile -->
  <div class="mobile-overlay" id="mobileOverlay"></div>

  <nav class="side-nav" id="sideNav">
    <div class="nav-title" style="display: flex; align-items: center; gap: 10px;">
      <img src="Image/Logo safe mate.png" alt="SafeMates Logo" style="width: 32px; height: 32px; border-radius: 50%;">
      <span>SafeMates</span>
    </div>
    <a class="nav-link" href="/dashboard"><i class="fas fa-home"></i><span>Accueil</span></a>
    <a class="nav-link" href="/contact.html"><i class="fas fa-envelope"></i><span>Contact</span></a>
    <a class="nav-link logout-link" href="#"><i class="fas fa-sign-out-alt"></i><span>Déconnexion</span></a>

    <button class="nav-toggle" data-target="navLinks">
      <span><i class="fas fa-link"></i> Liens utiles</span>
      <i class="fas fa-chevron-right chevron"></i>
    </button>
    <div class="nav-sublist" id="navLinks">
      <a href="https://www.tiktok.com/@SafeMatesfeminin?_r=1&_t=ZN-91t95JhqJxH" target="_blank" rel="noopener"><i class="fab fa-tiktok"></i> TikTok</a>
      <a href="https://www.instagram.com/SafeMates_girl/" target="_blank" rel="noopener"><i class="fab fa-instagram"></i> Instagram</a>
      <a href="https://x.com/MatesMatch13487" target="_blank" rel="noopener"><i class="fab fa-twitter"></i> X (Twitter)</a>
    </div>
  </nav>

  <header>
    <div class="logo">
      <img src="Image/Logo safe mate.png" alt="SafeMates" class="logo-img" width="40" height="40">
      <div class="logo-text">SafeMates</div>
    </div>
    <div class="nav-links">
      <a href="/">Tableau de bord</a>
      <a href="/contact.html">Contact</a>
      <a href="#" class="logout-link-header">Déconnexion</a>
    </div>
    <div class="profile-section">
      <!-- Bouton notifications -->
      <button class="notification-bell" id="notificationBell" onclick="toggleNotifications()">
          <i class="fas fa-bell"></i>
          <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
      </button>
      
      <div class="user-avatar" id="userAvatar"></div>
      <span class="username-display" id="userNameDisplay" style="color: var(--text-main); margin-left: 10px; font-weight: 500;"></span>
    </div>

    <!-- Panel des notifications -->
    <div class="notifications-panel" id="notificationsPanel">
        <div class="notifications-header">
            <h3>Notifications</h3>
            <button class="clear-all-btn" onclick="markAllAsRead()">Tout marquer comme lu</button>
        </div>
        <div class="notifications-list" id="notificationsList">
            <div class="notifications-empty">Aucune notification</div>
        </div>
    </div>
  </header>

  <div class="dashboard-layout">

    <div class="library-section">
      <h2>Jeux</h2>

      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Rechercher un jeu...">
      </div>

      <div class="library-grid" id="libraryGrid">
        <!-- Fallback statique au cas où le JS est bloqué -->
        <div class="game-card"><a href="game.html?game=valorant"><img src="Image/Image_jeux/valorant.jpg" alt="Valorant" class="game-img" loading="lazy" width="300" height="400"><div class="game-overlay"><div class="game-title">Valorant</div></div></a></div>
        <div class="game-card"><a href="game.html?game=lol"><img src="Image/Image_jeux/lol.jpg" alt="League of Legends" class="game-img"><div class="game-overlay"><div class="game-title">League of Legends</div></div></a></div>
        <div class="game-card"><a href="game.html?game=csgo"><img src="Image/Image_jeux/csgo.jpg" alt="CS:GO" class="game-img"><div class="game-overlay"><div class="game-title">CS:GO</div></div></a></div>
        <div class="game-card"><a href="game.html?game=rocketleague"><img src="Image/Image_jeux/rocketleague.jpg" alt="Rocket League" class="game-img"><div class="game-overlay"><div class="game-title">Rocket League</div></div></a></div>
        <div class="game-card"><a href="game.html?game=fortnite"><img src="Image/Image_jeux/fortnite.jpg" alt="Fortnite" class="game-img"><div class="game-overlay"><div class="game-title">Fortnite</div></div></a></div>
        <div class="game-card"><a href="game.html?game=warzone"><img src="Image/Image_jeux/warzone.avif" alt="Call of Duty: Warzone" class="game-img"><div class="game-overlay"><div class="game-title">Call of Duty: Warzone</div></div></a></div>
      </div>
    </div>

  </div>
  
    <button class="toggle-friends-btn" id="toggleFriendsBtn">
        <i class="fas fa-users"></i> <span>Amis</span>
        <span class="friends-notification-badge" id="friendsNotificationBadge">0</span>
    </button>
    
    <aside class="friends-sidebar" id="friendsSidebar">
        <div class="social-header">
            <h2 style="margin: 0; font-size: 1.1rem; color: var(--primary-color);">Social</h2>
            <div class="user-pill" id="connectedUsername">Utilisateur</div>
        </div>
        
        <div class="sidebar-section-title">Ajouter</div>
        <form class="add-friend-box" id="add-friend-form">
            <input type="text" id="friend-input" placeholder="Pseudo..." autocomplete="off">
            <button type="submit"><i class="fas fa-user-plus"></i></button>
        </form>
        <div id="friend-notif" style="color:var(--primary-color); font-size: 0.8rem; margin-top: 5px;"></div>

        <div class="sidebar-section-title">Amis (<span id="friendsCount">0</span>)</div>
        <div id="friendsList">
            <p style="text-align:center; color:var(--text-muted); font-size:0.9rem;">Ajoutez des amis !</p>
        </div>

        <div class="sidebar-section-title" id="receivedRequestsTitle" style="display:none;">Demandes reçues (<span id="receivedCount">0</span>)</div>
        <div id="requestsList">
            </div>
        
        <div class="sidebar-section-title" id="sentRequestsTitle" style="display:none;">Demandes envoyées (<span id="sentCount">0</span>)</div>
        <div id="sentList">
            </div>

    </aside>
    
<div id="chat-container" class="chat-container"></div>

<!-- 1️⃣ Charger le ChatManager EN PREMIER -->
<script src="chatmanager.js?v=1768165762094"></script>

<!-- 2️⃣ Script principal -->
<script>
// ====================================================
// --- DÉCLARATION DES VARIABLES GLOBALES ---
// ====================================================
// Variables sociales/chat
const activeChats = {};
const friendsSidebar = document.getElementById('friendsSidebar');
const chatContainer = document.getElementById('chat-container');
// Configuration de l'API - Utiliser l'API PHP locale sur Hostinger
const API_BASE_URL = '';

// Le nom d'utilisateur sera mis à jour par loadSocial() au chargement

// Variables bibliothèque/jeux
const libraryGrid = document.getElementById('libraryGrid');
const searchInput = document.getElementById('searchInput');
let isSearching = false;

// S'abonner aux mises à jour du ChatManager
if (window.ChatManager && window.ChatManager.subscribe) {
    window.ChatManager.subscribe(() => {
        // Mettre à jour tous les chats ouverts
        Object.keys(activeChats).forEach(username => {
            updateChatUI(username);
        });

        // Mettre à jour les badges de notification
        updateFriendsNotificationBadge();

        // Rafraîchir la liste d'amis pour les badges individuels
        const friendsList = document.getElementById('friendsList');
        if (friendsList && friendsList.children.length > 0) {
            loadSocial();
        }
    });
}

// ====================================================
// --- SYSTÈME DE NOTIFICATIONS ---
// ====================================================

let notifications = [];
let notificationInterval;

// Basculer l'affichage des notifications
window.toggleNotifications = function() {
    const panel = document.getElementById('notificationsPanel');
    panel.classList.toggle('active');
    
    if (panel.classList.contains('active')) {
        loadNotifications();
    }
};

// Charger les notifications
async function loadNotifications() {
    try {
        const response = await fetchProtected('/api/notifications');
        if (response.ok) {
            notifications = await response.json();
            renderNotifications();
            updateNotificationBadge();
        }
    } catch (error) {
        console.error('Erreur chargement notifications:', error);
    }
}

// Afficher les notifications
function renderNotifications() {
    const list = document.getElementById('notificationsList');
    if (!list) return;
    
    if (notifications.length === 0) {
        list.innerHTML = '<div class="notifications-empty">Aucune notification</div>';
        return;
    }
    
    list.innerHTML = notifications.map(notif => `
        <div class="notification-item ${notif.is_read ? '' : 'unread'}" 
             onclick="handleNotificationClick(${notif.id}, '${notif.type}', ${notif.related_id})">
            <div class="notification-icon ${notif.type}">
                <i class="fas ${
                    notif.type === 'friend_request' ? 'fa-user-plus' : 
                    notif.type === 'new_message' ? 'fa-comment' : 'fa-users'
                }"></i>
            </div>
            <div class="notification-content">
                <div class="notification-title">${notif.title}</div>
                <div class="notification-message">${notif.message}</div>
                <div class="notification-time">${formatTime(notif.created_at)}</div>
            </div>
        </div>
    `).join('');
}

// Mettre à jour le badge de notification
function updateNotificationBadge() {
    const badge = document.getElementById('notificationBadge');
    const unreadCount = notifications.filter(n => !n.is_read).length;
    
    if (unreadCount > 0) {
        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
        badge.style.display = 'flex';
    } else {
        badge.style.display = 'none';
    }
}

// Gérer le clic sur une notification
window.handleNotificationClick = async function(notificationId, type, relatedId) {
    await fetchProtected(`/api/notifications/${notificationId}/read`, {
        method: 'POST'
    });
    
    switch (type) {
        case 'friend_request':
            if (!friendsSidebar.classList.contains('active')) {
                toggleSidebar();
            }
            break;
        case 'new_message':
            if (relatedId) {
                const userResponse = await fetchProtected(`/api/user/${relatedId}`);
                if (userResponse.ok) {
                    const user = await userResponse.json();
                    openChat(user.username);
                }
            }
            break;
    }
    
    loadNotifications();
};

// Marquer toutes comme lues
window.markAllAsRead = async function() {
    await fetchProtected('/api/notifications/read-all', {
        method: 'POST'
    });
    loadNotifications();
};

// Formater l'heure
function formatTime(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'À l\'instant';
    if (diffMins < 60) return `Il y a ${diffMins} min`;
    if (diffHours < 24) return `Il y a ${diffHours} h`;
    if (diffDays < 7) return `Il y a ${diffDays} j`;
    return date.toLocaleDateString('fr-FR');
}

// Fermer les notifications en cliquant à l'extérieur
document.addEventListener('click', function(event) {
    const panel = document.getElementById('notificationsPanel');
    const bell = document.getElementById('notificationBell');
    
    if (panel && panel.classList.contains('active') && 
        !panel.contains(event.target) && 
        !bell.contains(event.target)) {
        panel.classList.remove('active');
    }
});

// Démarrer la surveillance des notifications
function startNotificationPolling() {
    loadNotifications();
    notificationInterval = setInterval(loadNotifications, 10000);
}

// ====================================================
// --- HEARTBEAT POUR MAINTENIR L'ACTIVITÉ EN LIGNE ---
// ====================================================
async function sendHeartbeat() {
    try {
        const response = await fetchProtected('/api/heartbeat.php', {
            method: 'POST'
        });
        if (!response.ok) {
            console.warn('Heartbeat failed:', response.status);
        }
    } catch (error) {
        console.error('Erreur heartbeat:', error);
    }
}

// Démarrer l'envoi régulier du heartbeat
function startHeartbeat() {
    // Envoyer immédiatement
    sendHeartbeat();
    // Puis toutes les 5 minutes (300000ms)
    setInterval(sendHeartbeat, 300000);
}

// ====================================================
// --- AFFICHAGE DU NOM D'UTILISATEUR DANS LE HEADER ---
// ====================================================
async function updateUserProfileDisplay() {
    let username = localStorage.getItem('username');

    // Si le username n'est pas dans localStorage, le récupérer depuis l'API
    if (!username || username === 'undefined' || username === 'null') {
        try {
            const response = await fetchProtected('/api/user/profile');
            if (response.ok) {
                const data = await response.json();
                if (data.username) {
                    username = data.username;
                    localStorage.setItem('username', username);
                }
            }
        } catch (error) {
            console.error('Erreur lors de la récupération du profil:', error);
        }
    }

    if (username && username !== 'undefined' && username !== 'null') {
        const userAvatar = document.getElementById('userAvatar');
        if (userAvatar) {
            userAvatar.textContent = username.charAt(0).toUpperCase();
            userAvatar.title = `Profil de ${username}`;
        }

        const userNameDisplay = document.getElementById('userNameDisplay');
        if (userNameDisplay) {
            userNameDisplay.textContent = username;
        }
    } else {
        const userAvatar = document.getElementById('userAvatar');
        if (userAvatar) {
            userAvatar.textContent = 'U';
        }

        const userNameDisplay = document.getElementById('userNameDisplay');
        if (userNameDisplay) {
            userNameDisplay.textContent = '';
        }
    }
}

// ====================================================
// --- FONCTIONS JWT UTILS ---
// ====================================================

function getAuthHeader() {
    const token = localStorage.getItem('token');
    return token ? { 'Authorization': `Bearer ${token}` } : {};
}

async function fetchProtected(url, options = {}) {
    const headers = {
        'Content-Type': 'application/json',
        ...getAuthHeader(),
        ...(options.headers || {})
    };

    // Construire l'URL complète avec l'API Railway
    const fullUrl = url.startsWith('http') ? url : `${API_BASE_URL}${url}`;

    const response = await fetch(fullUrl, {
        ...options,
        headers: headers,
    });

    if (response.status === 401) {
        alert("Session expirée. Veuillez vous reconnecter.");
        localStorage.removeItem('token');
        localStorage.removeItem('username');
        window.location.href = '/login';
    }

    return response;
}

/* =========================================
CONFIG JEUX / FAVORIS
========================================= */
const ALL_GAMES = [
    { id: 'valorant', name: 'Valorant', img: 'Image/Image_jeux/valorant.jpg' },
    { id: 'lol', name: 'League of Legends', img: 'Image/Image_jeux/lol.jpg' },
    { id: 'csgo', name: 'CS:GO', img: 'Image/Image_jeux/csgo.jpg' },
    { id: 'rocketleague', name: 'Rocket League', img: 'Image/Image_jeux/rocketleague.jpg' },
    { id: 'fortnite', name: 'Fortnite', img: 'Image/Image_jeux/fortnite.jpg' },
    { id: 'warzone', name: 'Call of Duty: Warzone', img: 'Image/Image_jeux/warzone.avif' },
];

// Version du site pour forcer le nettoyage du cache
const SITE_VERSION = '2.0.2';
const currentVersion = localStorage.getItem('mm_site_version');
const hasRefreshed = sessionStorage.getItem('mm_has_refreshed');

// Si la version a changé ou n'existe pas, forcer un hard refresh
if (currentVersion !== SITE_VERSION && !hasRefreshed) {
    console.log('Nouvelle version détectée, rechargement forcé...');
    sessionStorage.setItem('mm_has_refreshed', 'true');
    localStorage.setItem('mm_site_version', SITE_VERSION);
    // Forcer un hard refresh
    window.location.reload(true);
}

// Nettoyer les favoris des jeux supprimés
const validGameIds = ALL_GAMES.map(g => g.id);
let favorites = JSON.parse(localStorage.getItem('mm_favorites')) || [];
const oldFavCount = favorites.length;
favorites = favorites.filter(id => validGameIds.includes(id));

// Sauvegarder seulement si changement
if (favorites.length !== oldFavCount) {
    localStorage.setItem('mm_favorites', JSON.stringify(favorites));
    console.log('Favoris nettoyés:', oldFavCount - favorites.length, 'jeux supprimés');
}

// Effacer le flag de refresh pour les prochains chargements normaux
sessionStorage.removeItem('mm_has_refreshed'); 

function renderSideNavGames() {
    const container = document.getElementById('navGames');
    if (!container) return;
    container.innerHTML = ALL_GAMES.map(g => `<a href="game.html?game=${g.id}"><i class="fas fa-caret-right"></i> ${g.name}</a>`).join('');
}

function createCardHTML(game) {
    return `
        <a href="game.html?game=${game.id}">
            <img src="${game.img}" alt="${game.name}" class="game-img">
            <div class="game-overlay">
                <div class="game-title">${game.name}</div>
            </div>
        </a>
    `;
}

/* =========================================
LOGIQUE BIBLIOTHEQUE / RECHERCHE
========================================= */

function getFilteredGames() {
    const term = searchInput ? searchInput.value.toLowerCase().trim() : '';
    return term ? ALL_GAMES.filter(g => g.name.toLowerCase().includes(term)) : ALL_GAMES;
}

function renderLibrary(list) {
    if (!libraryGrid) return;
    const games = (list && list.length ? list : ALL_GAMES) || [];
    libraryGrid.innerHTML = "";

    if (games.length === 0) {
        libraryGrid.innerHTML = '<div class="empty-msg">Aucun jeu trouve.</div>';
        return;
    }

    games.forEach(g => { 
        const d = document.createElement('div'); 
        d.className = 'game-card'; 
        d.innerHTML = createCardHTML(g); 
        libraryGrid.appendChild(d); 
    }); 
}

function setupSideNavToggles() {
    document.querySelectorAll('.nav-toggle').forEach(btn => {
        const target = document.getElementById(btn.dataset.target);
        if (!target) return;
        btn.addEventListener('click', () => {
            btn.classList.toggle('open');
            target.classList.toggle('open');
        });
    });
}

if (searchInput) {
    searchInput.addEventListener('input', (e) => { 
        const term = e.target.value.toLowerCase().trim(); 
        isSearching = term.length > 0; 
        renderLibrary(getFilteredGames()); 
    });
}

// ====================================================
// --- FONCTION DE DÉCONNEXION ---
// ====================================================
function logout() {
    localStorage.removeItem('token');
    localStorage.removeItem('username');
    localStorage.removeItem('mm_friends_data');
    window.location.href = '/';
}

// Attacher les event listeners pour les boutons de déconnexion
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.logout-link, .logout-link-header').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            logout();
        });
    });
});

// ====================================================
// --- SYNCHRONISATION DES DONNÉES SOCIALES ---
// ====================================================

window.addEventListener('storage', function(e) {
    if (e.key === 'mm_friends_data') {
        const fData = JSON.parse(e.newValue || '{}');
        renderFriends(fData.friends || []);
        renderRequests(fData.incomingRequests || []); 
        renderSent(fData.outgoingRequests || []); 
    }
});

function syncFriendsData() {
    const currentData = localStorage.getItem('mm_friends_data');
    localStorage.setItem('mm_friends_data', currentData);
    setTimeout(loadSocial, 100);
}

// ====================================================
// --- LOGIQUE SOCIALE AVEC SYNCHRONISATION ---
// ====================================================

// Fonction pour mettre à jour le badge de notification du bouton Amis
function updateFriendsNotificationBadge() {
    const badge = document.getElementById('friendsNotificationBadge');
    if (!badge) return;

    // Compter les demandes d'amis reçues
    const receivedCount = parseInt(document.getElementById('receivedCount')?.textContent || '0');

    // Compter les messages non lus
    const unreadMessagesCount = window.ChatManager ? window.ChatManager.getTotalUnreadCount() : 0;

    // Total
    const totalNotifications = receivedCount + unreadMessagesCount;

    if (totalNotifications > 0) {
        badge.textContent = totalNotifications > 99 ? '99+' : totalNotifications;
        badge.classList.add('active');
    } else {
        badge.classList.remove('active');
    }
}

window.toggleSidebar = function() {
    const friendsSidebar = document.getElementById('friendsSidebar');
    if (!friendsSidebar) return;
    const isActive = friendsSidebar.classList.toggle('active');
    const toggleBtn = document.querySelector('.toggle-friends-btn');

    if (toggleBtn) toggleBtn.classList.toggle('active', isActive);

    if (!isActive) {
        if (typeof activeChats !== 'undefined' && typeof closeChat === 'function') {
            Object.keys(activeChats).forEach(closeChat);
        }
    }

    localStorage.setItem('socialSidebarActive', isActive);
};

async function loadSocial() {
    try {
        const fRes = await fetchProtected('/api/friends');

        if (!fRes.ok) {
            throw new Error("Erreur de récupération des données sociales.");
        }

        const fData = await fRes.json();

        localStorage.setItem('mm_friends_data', JSON.stringify(fData));

        // Mise à jour du nom d'utilisateur dans la sidebar
        const userPill = document.getElementById('connectedUsername');
        if (userPill) {
            const storedUsername = localStorage.getItem('username');
            if (storedUsername && storedUsername !== 'undefined' && storedUsername !== 'null') {
                userPill.textContent = storedUsername;
            } else {
                // Essayer de récupérer le username depuis l'API
                userPill.textContent = 'Chargement...';
                try {
                    const profileRes = await fetchProtected('/api/user/profile');
                    if (profileRes.ok) {
                        const profile = await profileRes.json();
                        if (profile.username) {
                            localStorage.setItem('username', profile.username);
                            userPill.textContent = profile.username;
                        } else {
                            userPill.textContent = 'Utilisateur';
                        }
                    } else {
                        userPill.textContent = 'Utilisateur';
                    }
                } catch (err) {
                    console.error('Erreur récupération username:', err);
                    userPill.textContent = 'Utilisateur';
                }
            }
        }

        renderFriends(fData.friends || []);
        renderRequests(fData.incomingRequests || []);
        renderSent(fData.outgoingRequests || []);

        // Mettre à jour le badge de notification
        updateFriendsNotificationBadge();

    } catch (e) {
        const cachedData = localStorage.getItem('mm_friends_data');
        if (cachedData) {
            const fData = JSON.parse(cachedData);
            renderFriends(fData.friends || []);
            renderRequests(fData.incomingRequests || []); 
            renderSent(fData.outgoingRequests || []); 
        } else {
            renderFriends([]);
            renderRequests([]); 
            renderSent([]); 
        }
        console.error("Erreur chargement social:", e);
    }
}

function renderFriends(list) {
    const c = document.getElementById('friendsList');
    if (!c) return;
    c.innerHTML = "";
    const countSpan = document.getElementById('friendsCount');
    if(countSpan) countSpan.textContent = list.length;
    
    if (!list.length) {
        c.innerHTML = `<p style="text-align:center; color:var(--text-muted); font-size:0.9rem;">Ajoutez des amis !</p>`;
        return;
    }

    list.forEach(f => {
        const d = document.createElement('div');
        d.className = 'friend-card';

        // Vérifier si cet ami a des messages non lus
        const unreadCount = window.ChatManager ? window.ChatManager.getUnreadCount(f.username) : 0;

        d.innerHTML = `
            <div style="display: flex; align-items: center; flex: 1; cursor: pointer;" class="friend-card-content">
                <div class="friend-avatar">${f.username.charAt(0).toUpperCase()}</div>
                <span>${f.username}</span>
            </div>
            ${unreadCount > 0 ? `<span class="friend-card-badge" id="badge-${f.username}">${unreadCount}</span>` : ''}
            <div class="friend-menu-container">
                <button type="button" class="friend-menu-btn" data-username="${f.username}">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <div class="friend-menu-dropdown">
                    <button class="friend-menu-item report-friend-btn" data-username="${f.username}">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Signaler</span>
                    </button>
                    <button class="friend-menu-item remove-friend-btn" data-username="${f.username}">
                        <i class="fas fa-trash"></i>
                        <span>Supprimer l'ami</span>
                    </button>
                </div>
            </div>
        `;

        // Ajouter le gestionnaire de clic pour ouvrir le chat sur le contenu de la carte
        const contentDiv = d.querySelector('.friend-card-content');
        if (contentDiv) {
            contentDiv.addEventListener('click', () => {
                console.log('Ouverture du chat avec:', f.username);
                openChat(f.username);
            });
        }

        // Ajouter le gestionnaire pour le menu trois points
        const menuBtn = d.querySelector('.friend-menu-btn');
        const menuDropdown = d.querySelector('.friend-menu-dropdown');
        if (menuBtn && menuDropdown) {
            menuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                // Fermer tous les autres menus ouverts
                document.querySelectorAll('.friend-menu-dropdown.show').forEach(dropdown => {
                    if (dropdown !== menuDropdown) {
                        dropdown.classList.remove('show');
                    }
                });
                // Toggle le menu actuel
                menuDropdown.classList.toggle('show');
            });
        }

        // Ajouter le gestionnaire pour le bouton de signalement
        const reportBtn = d.querySelector('.report-friend-btn');
        if (reportBtn) {
            reportBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                const username = reportBtn.dataset.username;
                if (typeof window.openReportModal === 'function') {
                    window.openReportModal(username);
                } else {
                    alert('Le module de signalement est indisponible pour le moment.');
                }
            });
        }

        // Ajouter le gestionnaire pour le bouton de suppression
        const removeBtn = d.querySelector('.remove-friend-btn');
        if (removeBtn) {
            removeBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                e.preventDefault();
                const username = removeBtn.dataset.username;
                if (confirm(`Voulez-vous vraiment supprimer ${username} de vos amis ?`)) {
                    await removeFriend(username);
                }
            });
        }

        c.appendChild(d);
    });
}

function renderRequests(list) {
    const c = document.getElementById('requestsList');
    if (!c) return;
    c.innerHTML = "";
    const countSpan = document.getElementById('receivedCount');
    if(countSpan) countSpan.textContent = list.length;
    const title = document.getElementById('receivedRequestsTitle');
    if(title) title.style.display = list.length ? 'block' : 'none';

    list.forEach(r => {
        const d = document.createElement('div');
        d.className = 'friend-card';
        d.innerHTML = `
            <div style="display: flex; align-items: center; flex-grow: 1;">
                <div class="friend-avatar">${r.username.charAt(0).toUpperCase()}</div>
                <span>${r.username}</span>
            </div>
            <div class="request-actions" style="display:flex; gap:5px;">
                <button type="button" class="action-btn accept request-action-btn" data-username="${r.username}" data-action="accept"><i class="fas fa-check"></i></button>
                <button type="button" class="action-btn reject request-action-btn" data-username="${r.username}" data-action="reject"><i class="fas fa-times"></i></button>
            </div>
        `;
        c.appendChild(d);
    });
}

function renderSent(list) {
    const c = document.getElementById('sentList');
    if (!c) return;
    c.innerHTML = "";
    const countSpan = document.getElementById('sentCount');
    if(countSpan) countSpan.textContent = list.length;
    const title = document.getElementById('sentRequestsTitle');
    if(title) title.style.display = list.length ? 'block' : 'none';

    list.forEach(r => {
        const d = document.createElement('div');
        d.className = 'friend-card';
        d.style.opacity = 0.7; 
        d.innerHTML = `
            <div style="display: flex; align-items: center; flex-grow: 1;">
                <div class="friend-avatar">${r.username.charAt(0).toUpperCase()}</div>
                <span style="font-style:italic;">${r.username} (En attente)</span>
            </div>
        `;
        c.appendChild(d);
    });
}

const addFriendForm = document.getElementById('add-friend-form');
if (addFriendForm) {
    addFriendForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const input = document.getElementById('friend-input');
        const friendNotif = document.getElementById('friend-notif');

        if (!input.value.trim()) {
            friendNotif.innerText = "Veuillez entrer un pseudo.";
            friendNotif.style.color = "#ef4444";
            setTimeout(()=>friendNotif.innerText="",3000);
            return;
        }

        // Vérifier que l'utilisateur est connecté
        if (!localStorage.getItem('token')) {
            friendNotif.innerText = "Vous devez être connecté.";
            friendNotif.style.color = "#ef4444";
            setTimeout(() => {
                window.location.href = '/login';
            }, 2000);
            return;
        }

        try {
            console.log("Envoi demande ami à:", input.value.trim());
            const res = await fetchProtected('/api/friends/send', {
                method:'POST',
                body:JSON.stringify({receiverUsername:input.value.trim()})
            });

            if (!res) {
                friendNotif.style.color = "#ef4444";
                friendNotif.innerText = "Session expirée. Reconnectez-vous.";
                setTimeout(()=>friendNotif.innerText="",3000);
                return;
            }

            // Vérifier le type de contenu
            const contentType = res.headers.get('content-type');
            console.log("Status:", res.status, "Content-Type:", contentType);
            if (!contentType || !contentType.includes('application/json')) {
                console.error("Réponse non-JSON reçue. Status:", res.status, "Content-Type:", contentType);
                const text = await res.text();
                console.error("Contenu de la réponse:", text.substring(0, 200));
                friendNotif.style.color = "#ef4444";
                if (res.status === 401) {
                    friendNotif.innerText = "Session expirée. Reconnectez-vous.";
                } else if (res.status === 404) {
                    friendNotif.innerText = "Utilisateur introuvable.";
                } else if (res.status >= 500) {
                    friendNotif.innerText = "Erreur serveur (code " + res.status + ")";
                } else {
                    friendNotif.innerText = "Erreur (code " + res.status + ")";
                }
                setTimeout(()=>friendNotif.innerText="",5000);
                return;
            }

            const d = await res.json();

            if (res.ok) {
                friendNotif.style.color = "var(--primary-color)";
                friendNotif.innerText = d.message || "Demande envoyée !";
                input.value = "";
                syncFriendsData();
            } else {
                friendNotif.style.color = "#ef4444";
                friendNotif.innerText = d.error || d.message || "Erreur lors de l'envoi.";
            }
            setTimeout(()=>friendNotif.innerText="",5000);
        } catch (err) {
            console.error("Erreur ajout ami:", err);
            friendNotif.style.color = "#ef4444";
            if (err.message && err.message.includes('JSON')) {
                friendNotif.innerText = "Session expirée. Reconnectez-vous.";
            } else {
                friendNotif.innerText = "Erreur de connexion au serveur.";
            }
            setTimeout(()=>friendNotif.innerText="",5000);
        }
    });
}

const requestsListEl = document.getElementById('requestsList');
if (requestsListEl) {
    requestsListEl.addEventListener('click', (e) => {
        const btn = e.target.closest('.request-action-btn');
        if (!btn) return;
        const username = btn.dataset.username;
        const action = btn.dataset.action;
        hReq(username, action, e);
    });
}

window.hReq = async(username, action, evt) => { 
    if (evt && typeof evt.stopPropagation === 'function') {
        evt.stopPropagation();
        evt.preventDefault();
    }
    const btn = evt?.currentTarget;
    if (btn) btn.disabled = true;
    const card = btn?.closest?.('.friend-card');
    if (card) card.classList.add('processing');
    const statusEl = document.getElementById('friend-notif');
    if (statusEl) {
        statusEl.style.color = '#22c55e';
        statusEl.innerText = 'Traitement...';
    }

    try {
        if (action === 'accept' || action === 'reject') {
            const payload = {
                username: username,
                action: action
            };
            
            const res = await fetchProtected('/api/friends/respond', {
                method:'POST',
                body:JSON.stringify(payload)
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) {
                if (statusEl) {
                    statusEl.style.color = '#ef4444';
                    statusEl.innerText = data.error || "Erreur lors de l'action sur la demande d'ami.";
                } else {
                    alert(data.error || "Erreur lors de l'action sur la demande d'ami.");
                }
                return;
            }
            if (statusEl) {
                statusEl.style.color = '#22c55e';
                statusEl.innerText = data.message || (action === 'accept' ? 'Ami ajouté.' : 'Demande refusée.');
            }
            if (card) card.remove();
        }
        await loadSocial();
    } catch (e) {
        console.error('Erreur hReq:', e);
        if (statusEl) {
            statusEl.style.color = '#ef4444';
            statusEl.innerText = "Impossible de traiter la demande pour l'instant.";
        } else {
            alert("Impossible de traiter la demande pour l'instant.");
        }
    } finally {
        if (btn) btn.disabled = false;
        if (card) card.classList.remove('processing');
    }
};

// Fonction pour supprimer un ami
async function removeFriend(username) {
    try {
        const res = await fetchProtected('/api/friends/remove', {
            method: 'DELETE',
            body: JSON.stringify({ friendUsername: username })
        });

        if (res.ok) {
            const data = await res.json();
            const statusEl = document.getElementById('friend-notif');
            if (statusEl) {
                statusEl.style.color = '#22c55e';
                statusEl.innerText = data.message || `${username} a été retiré de vos amis.`;
                setTimeout(() => statusEl.innerText = "", 3000);
            }
            // Fermer le chat s'il est ouvert
            if (activeChats[username]) {
                closeChat(username);
            }
            await loadSocial();
        } else {
            const error = await res.json();
            alert(error.message || "Erreur lors de la suppression de l'ami.");
        }
    } catch (error) {
        console.error('Erreur suppression ami:', error);
        alert("Impossible de supprimer cet ami pour l'instant.");
    }
}

// ====================================================
// --- LOGIQUE DE CHAT AVEC CHATMANAGER GLOBAL ---
// ====================================================

function updateChatUI(username) {
    const chatBody = document.getElementById(`msg-${username}`);
    if (!chatBody) return;
    
    const messages = window.ChatManager.getMessagesWithUser(username);
    const isScrolledToBottom = chatBody.scrollHeight - chatBody.clientHeight <= chatBody.scrollTop + 1;
    
    chatBody.innerHTML = messages.map(msg => {
        const isOwn = window.ChatManager.isOwnMessage(msg);
        return `
            <div class="msg ${isOwn ? 'self' : 'other'}">
                ${msg.content}
            </div>
        `;
    }).join('');
    
    if (isScrolledToBottom || messages.length <= 1) {
        chatBody.scrollTop = chatBody.scrollHeight;
    }
}

window.openChat = (username) => { 
    if(document.getElementById(`cw-${username}`)) return;
    
    const chatWindow = document.createElement('div');
    chatWindow.className = 'chat-window';
    chatWindow.id = `cw-${username}`;
    
    chatWindow.innerHTML = `
        <div class="chat-header" data-close-chat="${username}">
            <span>${username}</span>
            <span><i class="fas fa-times"></i></span>
        </div>
        <div class="chat-body" id="msg-${username}"></div>
        <form class="chat-input-area" data-username="${username}">
            <input type="text" placeholder="Écrire un message..." autocomplete="off">
            <button type="submit"><i class="fas fa-paper-plane"></i></button>
        </form>
    `;
    
    if (chatContainer) {
        chatContainer.appendChild(chatWindow);
        
        window.ChatManager.registerActiveChat(username);
        activeChats[username] = true;
        
        const form = chatWindow.querySelector('.chat-input-area');
        if (form) {
            form.addEventListener('submit', (evt) => {
                evt.preventDefault();
                sendMessage(evt, username);
            });
        }
        const header = chatWindow.querySelector('[data-close-chat]');
        if (header) {
            header.addEventListener('click', () => closeChat(username));
        }
        
        const updateCallback = () => updateChatUI(username);
        window.ChatManager.subscribe(updateCallback);
        
        if (!activeChats[username + '_callback']) {
            activeChats[username + '_callback'] = updateCallback;
        }

        updateChatUI(username);

        // Marquer les messages comme lus
        window.ChatManager.markAsRead(username);

        // Mettre à jour les badges
        updateFriendsNotificationBadge();

        // Rafraîchir l'affichage des amis pour mettre à jour les badges individuels
        loadSocial();
    }
};

window.closeChat = (username) => { 
    const el = document.getElementById(`cw-${username}`); 
    if(el) el.remove();
    
    window.ChatManager.unregisterActiveChat(username);
    
    const callback = activeChats[username + '_callback'];
    if (callback) {
        window.ChatManager.unsubscribe(callback);
        delete activeChats[username + '_callback'];
    }
    
    delete activeChats[username];
};

window.sendMessage = async (e, username) => {
    e.preventDefault();
    const input = e.target.querySelector('input');
    if (!input.value.trim()) return;
    
    const result = await window.ChatManager.sendMessage(username, input.value.trim());
    
    if (result.success) {
        input.value = "";
        updateChatUI(username);
    } else {
        console.error('Erreur envoi message:', result.error);
        alert('Erreur lors de l\'envoi du message');
    }
};

// ====================================================
// --- INITIALISATION AVEC SYNCHRONISATION ---
// ====================================================

function startSocialSync() {
    loadSocial();
    setInterval(() => {
        loadSocial();
    }, 5000);
}

/* =========================================
MENU MOBILE
========================================= */

function setupMobileMenu() {
    const mobileMenuToggle = document.getElementById('mobileMenuToggle');
    const mobileOverlay = document.getElementById('mobileOverlay');
    const sideNav = document.getElementById('sideNav');

    if (mobileMenuToggle && mobileOverlay && sideNav) {
        // Ouvrir/Fermer le menu
        mobileMenuToggle.addEventListener('click', function() {
            sideNav.classList.toggle('mobile-active');
            mobileOverlay.classList.toggle('active');

            // Changer l'icône
            const icon = this.querySelector('i');
            if (sideNav.classList.contains('mobile-active')) {
                icon.classList.remove('fa-bars');
                icon.classList.add('fa-times');
            } else {
                icon.classList.remove('fa-times');
                icon.classList.add('fa-bars');
            }
        });

        // Fermer en cliquant sur l'overlay
        mobileOverlay.addEventListener('click', function() {
            sideNav.classList.remove('mobile-active');
            mobileOverlay.classList.remove('active');
            const icon = mobileMenuToggle.querySelector('i');
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
        });

        // Fermer en cliquant sur un lien
        sideNav.querySelectorAll('a.nav-link').forEach(link => {
            link.addEventListener('click', function() {
                if (window.innerWidth <= 768) {
                    sideNav.classList.remove('mobile-active');
                    mobileOverlay.classList.remove('active');
                    const icon = mobileMenuToggle.querySelector('i');
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-bars');
                }
            });
        });
    }
}

/* =========================================
INITIALISATION FINALE
========================================= */

(async function() {
    renderLibrary(ALL_GAMES);
    setupSideNavToggles();
    setupMobileMenu();
    const linksList = document.getElementById('navLinks');
    if (linksList) linksList.classList.add('open');
    document.querySelectorAll('.nav-toggle').forEach(btn => {
        if (btn.dataset.target === 'navLinks') btn.classList.add('open');
    });

    // Attacher l'écouteur d'événement au bouton Amis
    const toggleBtn = document.querySelector('.toggle-friends-btn');
    if (toggleBtn) {
        toggleBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            toggleSidebar();
        });
    }

    const friendsSidebar = document.getElementById('friendsSidebar');
    if (localStorage.getItem('socialSidebarActive') === 'true' && friendsSidebar) {
        friendsSidebar.classList.add('active');
        if(toggleBtn) toggleBtn.classList.add('active');
    }

    startSocialSync();
    updateUserProfileDisplay();
    startNotificationPolling();
    startHeartbeat();

    // Fermer le menu ami quand on clique en dehors
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.friend-menu-container')) {
            document.querySelectorAll('.friend-menu-dropdown.show').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
        }
    });
})();
</script>

<!-- Syst?me de signalement d'utilisateur -->
<script src="/report-user.js?v=1768165762094"></script>

</body>
</html>





